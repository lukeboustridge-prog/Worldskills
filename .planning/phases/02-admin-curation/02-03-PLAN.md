---
phase: 02-admin-curation
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/(dashboard)/settings/descriptors/page.tsx
  - src/app/(dashboard)/settings/descriptors/create/page.tsx
  - src/app/(dashboard)/settings/descriptors/[id]/edit/page.tsx
  - src/components/descriptors/delete-confirmation.tsx
  - src/components/descriptors/duplicate-warning.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of descriptors with search and filter controls"
    - "Admin can navigate to create page and submit new descriptor form"
    - "Admin can navigate to edit page for existing descriptor"
    - "Delete confirmation dialog prevents accidental deletions"
    - "Duplicate warning displays similar descriptors during create/edit"
  artifacts:
    - path: "src/app/(dashboard)/settings/descriptors/page.tsx"
      provides: "Descriptor list page with filtering"
      min_lines: 100
    - path: "src/app/(dashboard)/settings/descriptors/create/page.tsx"
      provides: "Create descriptor form with duplicate detection"
      min_lines: 80
    - path: "src/app/(dashboard)/settings/descriptors/[id]/edit/page.tsx"
      provides: "Edit descriptor form with duplicate detection"
      min_lines: 80
    - path: "src/components/descriptors/delete-confirmation.tsx"
      provides: "Delete confirmation dialog component"
      exports: ["DeleteConfirmation"]
    - path: "src/components/descriptors/duplicate-warning.tsx"
      provides: "Similar descriptor warning component"
      exports: ["DuplicateWarning"]
  key_links:
    - from: "src/app/(dashboard)/settings/descriptors/page.tsx"
      to: "getAllDescriptors"
      via: "import from lib/descriptors"
      pattern: "import.*getAllDescriptors.*from.*lib/descriptors"
    - from: "create/page.tsx"
      to: "createDescriptorAction"
      via: "form action"
      pattern: "action=\\{createDescriptorAction\\}"
    - from: "create/page.tsx"
      to: "findSimilarDescriptors"
      via: "import from lib/duplicate-detection"
      pattern: "import.*findSimilarDescriptors.*from.*lib/duplicate-detection"
    - from: "[id]/edit/page.tsx"
      to: "findSimilarDescriptors"
      via: "import from lib/duplicate-detection"
      pattern: "import.*findSimilarDescriptors.*from.*lib/duplicate-detection"
---

<objective>
Build the admin UI for descriptor management: list page with search/filter, create form, edit form, delete confirmation dialog, and duplicate warning component.

Purpose: Provide the admin interface for curating the descriptor library - viewing, creating, editing, and deleting descriptors with proper UX patterns (confirmation dialogs, warnings).

Output: Complete admin descriptor management UI matching existing settings patterns.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-curation/02-RESEARCH.md
@.planning/phases/02-admin-curation/02-01-SUMMARY.md
@.planning/phases/02-admin-curation/02-02-SUMMARY.md

Reference existing UI patterns:
@src/app/(dashboard)/settings/resources/page.tsx

Key UI patterns from existing code:
- Card components with CardHeader, CardTitle, CardDescription, CardContent
- Form with Server Action binding (`action={createAction}`)
- Error/success messages via searchParams
- Button variants (default, outline, destructive)
- Input and Textarea components
- Select with native HTML (styled with Tailwind)
- Lucide icons (ArrowLeft, Plus, Pencil, Trash2)
- Badge for labels
- Link for navigation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create descriptor list page with search and filters</name>
  <files>src/app/(dashboard)/settings/descriptors/page.tsx</files>
  <action>
Create `src/app/(dashboard)/settings/descriptors/page.tsx` following the pattern from `src/app/(dashboard)/settings/resources/page.tsx`:

Key features:
1. **Authorization**: Call `requireAdminUser()` at start
2. **Data fetching**: Use `getAllDescriptors()` with filters from searchParams
3. **Filter options**: Use `getDescriptorFilterOptions()` for dropdowns
4. **Search bar**: Text input that filters by criterionName, code, performance levels
5. **Filter dropdowns**: Skill, sector, category, quality indicator
6. **Descriptor list**: Cards showing code, criterionName, skillName, tags, qualityIndicator
7. **Action buttons**: Edit (Pencil icon link), Delete (with DeleteConfirmation component)
8. **Success/error messages**: Display based on searchParams (created, updated, deleted, error)
9. **Empty state**: Message when no descriptors match filters
10. **Create button**: Link to /settings/descriptors/create

Header section:
```tsx
<div className="flex items-center justify-between">
  <div className="flex items-center gap-4">
    <Button asChild variant="ghost" size="sm">
      <Link href="/settings">
        <ArrowLeft className="mr-2 h-4 w-4" />
        Back to Settings
      </Link>
    </Button>
  </div>
  <Button asChild>
    <Link href="/settings/descriptors/create">
      <Plus className="mr-2 h-4 w-4" />
      Add Descriptor
    </Link>
  </Button>
</div>
```

Filter section (form that updates searchParams):
```tsx
<Card>
  <CardHeader>
    <CardTitle>Filter Descriptors</CardTitle>
  </CardHeader>
  <CardContent>
    <form className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <Input name="search" placeholder="Search..." defaultValue={searchParams?.search} />
      <select name="skillName">
        <option value="">All Skills</option>
        {filterOptions.skills.map((s) => <option key={s} value={s}>{s}</option>)}
      </select>
      {/* Similar for sector, category, qualityIndicator */}
      <Button type="submit">Apply Filters</Button>
    </form>
  </CardContent>
</Card>
```

Descriptor list:
- Show descriptor count in CardDescription
- For each descriptor: code badge, criterionName, skill badge, quality badge, tags
- Truncate long text with line-clamp
- Show edit/delete buttons

Use these imports:
```tsx
import { QualityIndicator } from "@prisma/client";
import Link from "next/link";
import { ArrowLeft, Pencil, Plus, Trash2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { requireAdminUser } from "@/lib/auth";
import { getAllDescriptors, getDescriptorFilterOptions } from "@/lib/descriptors";
import { DeleteConfirmation } from "@/components/descriptors/delete-confirmation";
```

Quality indicator colors:
- EXCELLENT: green (bg-green-100 text-green-800)
- GOOD: blue (bg-blue-100 text-blue-800)
- REFERENCE: gray (bg-gray-100 text-gray-800)
- NEEDS_REVIEW: amber (bg-amber-100 text-amber-800)
  </action>
  <verify>Run `npx tsc --noEmit` and verify page renders at /settings/descriptors</verify>
  <done>Descriptor list page with search, filters, and CRUD action buttons</done>
</task>

<task type="auto">
  <name>Task 2a: Create descriptor create page</name>
  <files>src/app/(dashboard)/settings/descriptors/create/page.tsx</files>
  <action>
Create `src/app/(dashboard)/settings/descriptors/create/page.tsx`:

Features:
1. Authorization with `requireAdminUser()`
2. Error display from searchParams
3. **Fetch similar descriptors on load**: If `searchParams.criterionName` exists, call `findSimilarDescriptors(searchParams.criterionName)` and pass result to DuplicateWarning
4. Form with all descriptor fields:
   - code (Input, required)
   - criterionName (Input, required)
   - skillName (Input, required - consider making this a searchable dropdown later)
   - excellent, good, pass, belowPass (Textarea, 3 rows each)
   - sector, category (Input, optional)
   - tags (Input, comma-separated)
   - qualityIndicator (select, default REFERENCE)
5. Form action bound to `createDescriptorAction`
6. Cancel button linking back to list
7. DuplicateWarning component showing similar descriptors

Key imports:
```tsx
import { createDescriptorAction } from "@/app/(dashboard)/settings/descriptors/actions";
import { findSimilarDescriptors } from "@/lib/duplicate-detection";
import { DuplicateWarning } from "@/components/descriptors/duplicate-warning";
```

Page structure:
```tsx
export default async function CreateDescriptorPage({
  searchParams,
}: {
  searchParams: { criterionName?: string; error?: string };
}) {
  await requireAdminUser();

  // Fetch similar descriptors if criterionName provided (e.g., after form validation redirect)
  const similarDescriptors = searchParams.criterionName
    ? await findSimilarDescriptors(searchParams.criterionName)
    : [];

  return (
    <div className="space-y-6">
      {/* Header with back button */}

      {/* Error display if searchParams.error */}

      {/* DuplicateWarning if similar descriptors found */}
      <DuplicateWarning similar={similarDescriptors} />

      <Card>
        <CardHeader>
          <CardTitle>Create Descriptor</CardTitle>
        </CardHeader>
        <CardContent>
          <form action={createDescriptorAction} className="space-y-6">
            {/* Form fields */}
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

Form layout (2-column grid for short fields, full width for textareas):
```tsx
<form action={createDescriptorAction} className="space-y-6">
  <div className="grid gap-4 sm:grid-cols-2">
    <div className="space-y-2">
      <Label htmlFor="code">Code</Label>
      <Input id="code" name="code" required placeholder="A1" />
    </div>
    <div className="space-y-2">
      <Label htmlFor="skillName">Source Skill</Label>
      <Input id="skillName" name="skillName" required placeholder="Welding" />
    </div>
  </div>

  <div className="space-y-2">
    <Label htmlFor="criterionName">Criterion Name</Label>
    <Input id="criterionName" name="criterionName" required placeholder="Quality of weld seam" />
  </div>

  <div className="grid gap-4 sm:grid-cols-2">
    <div className="space-y-2">
      <Label htmlFor="excellent">Excellent</Label>
      <Textarea id="excellent" name="excellent" rows={3} placeholder="Description of excellent performance..." />
    </div>
    {/* Similar for good, pass, belowPass */}
  </div>

  {/* sector, category, tags, qualityIndicator */}

  <div className="flex gap-2">
    <Button type="submit">Create Descriptor</Button>
    <Button asChild variant="outline">
      <Link href="/settings/descriptors">Cancel</Link>
    </Button>
  </div>
</form>
```
  </action>
  <verify>Run `npx tsc --noEmit` and verify page renders at /settings/descriptors/create</verify>
  <done>Create page with complete form, duplicate detection wired, and validation display</done>
</task>

<task type="auto">
  <name>Task 2b: Create descriptor edit page</name>
  <files>src/app/(dashboard)/settings/descriptors/[id]/edit/page.tsx</files>
  <action>
Create `src/app/(dashboard)/settings/descriptors/[id]/edit/page.tsx`:

Similar to create page but:
1. Fetch existing descriptor with `getDescriptorById(params.id)`
2. Return `notFound()` if descriptor doesn't exist
3. Pre-populate all form fields with `defaultValue`
4. Hidden input for id
5. Form action bound to `updateDescriptorAction`
6. Show "Edit Descriptor" as title
7. Tags should display as comma-separated string: `defaultValue={descriptor.tags.join(", ")}`
8. **Fetch similar descriptors**: Call `findSimilarDescriptors(descriptor.criterionName, 0.4, params.id)` - note the excludeId parameter to exclude current descriptor from results

Key imports:
```tsx
import { notFound } from "next/navigation";
import { updateDescriptorAction } from "@/app/(dashboard)/settings/descriptors/actions";
import { getDescriptorById } from "@/lib/descriptors";
import { findSimilarDescriptors } from "@/lib/duplicate-detection";
import { DuplicateWarning } from "@/components/descriptors/duplicate-warning";
```

Page structure:
```tsx
export default async function EditDescriptorPage({
  params,
  searchParams,
}: {
  params: { id: string };
  searchParams: { error?: string };
}) {
  await requireAdminUser();

  const descriptor = await getDescriptorById(params.id);
  if (!descriptor) {
    notFound();
  }

  // Find similar descriptors, excluding current descriptor
  const similarDescriptors = await findSimilarDescriptors(
    descriptor.criterionName,
    0.4,
    params.id
  );

  return (
    <div className="space-y-6">
      {/* Header with back button */}

      {/* Error display if searchParams.error */}

      {/* DuplicateWarning if similar descriptors found */}
      <DuplicateWarning similar={similarDescriptors} />

      <Card>
        <CardHeader>
          <CardTitle>Edit Descriptor</CardTitle>
          <CardDescription>
            Editing: {descriptor.code} - {descriptor.criterionName}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form action={updateDescriptorAction} className="space-y-6">
            <input type="hidden" name="id" value={descriptor.id} />
            {/* Form fields with defaultValue from descriptor */}
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

Use consistent Card layout matching create page and resources page.
  </action>
  <verify>Run `npx tsc --noEmit` and verify page renders at /settings/descriptors/[id]/edit</verify>
  <done>Edit page with pre-populated form, duplicate detection wired, and validation display</done>
</task>

<task type="auto">
  <name>Task 3: Create delete confirmation and duplicate warning components</name>
  <files>
    src/components/descriptors/delete-confirmation.tsx
    src/components/descriptors/duplicate-warning.tsx
  </files>
  <action>
**Delete Confirmation** (`src/components/descriptors/delete-confirmation.tsx`):

Client component using native `<dialog>` element for accessibility:

```tsx
"use client";

import { useRef } from "react";
import { Trash2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { deleteDescriptorAction } from "@/app/(dashboard)/settings/descriptors/actions";

interface DeleteConfirmationProps {
  descriptorId: string;
  criterionName: string;
}

export function DeleteConfirmation({ descriptorId, criterionName }: DeleteConfirmationProps) {
  const dialogRef = useRef<HTMLDialogElement>(null);

  const handleDelete = async () => {
    const formData = new FormData();
    formData.set("id", descriptorId);
    await deleteDescriptorAction(formData);
  };

  return (
    <>
      <Button
        type="button"
        variant="outline"
        size="sm"
        onClick={() => dialogRef.current?.showModal()}
        className="text-destructive hover:bg-destructive hover:text-destructive-foreground"
      >
        <Trash2 className="h-4 w-4" />
      </Button>

      <dialog
        ref={dialogRef}
        className="rounded-lg border bg-background p-6 shadow-lg backdrop:bg-black/60"
      >
        <h2 className="text-lg font-semibold">Delete Descriptor</h2>
        <p className="mt-2 text-sm text-muted-foreground">
          Are you sure you want to delete "{criterionName}"?
        </p>
        <p className="mt-1 text-xs text-muted-foreground">
          This descriptor will be soft-deleted and can be restored if needed.
        </p>
        <div className="mt-6 flex justify-end gap-2">
          <Button
            type="button"
            variant="outline"
            onClick={() => dialogRef.current?.close()}
            autoFocus
          >
            Cancel
          </Button>
          <Button
            type="button"
            variant="destructive"
            onClick={handleDelete}
          >
            Delete
          </Button>
        </div>
      </dialog>
    </>
  );
}
```

**IMPORTANT**: Use absolute import path `@/app/(dashboard)/settings/descriptors/actions` for `deleteDescriptorAction`.

**Duplicate Warning** (`src/components/descriptors/duplicate-warning.tsx`):

Server component that displays similar descriptors:

```tsx
import Link from "next/link";
import { Badge } from "@/components/ui/badge";

interface SimilarDescriptor {
  id: string;
  code: string;
  criterionName: string;
  skillName: string;
  similarity: number;
}

interface DuplicateWarningProps {
  similar: SimilarDescriptor[];
}

export function DuplicateWarning({ similar }: DuplicateWarningProps) {
  if (!similar || similar.length === 0) return null;

  return (
    <div className="rounded-md border border-amber-500 bg-amber-50 p-4 dark:bg-amber-950">
      <h3 className="font-medium text-amber-900 dark:text-amber-100">
        Similar descriptors found
      </h3>
      <p className="mt-1 text-sm text-amber-700 dark:text-amber-300">
        Review these similar descriptors to avoid duplicates:
      </p>
      <ul className="mt-3 space-y-2">
        {similar.map((s) => (
          <li key={s.id} className="flex items-start gap-2 text-sm">
            <Badge variant="outline">{s.code}</Badge>
            <div className="flex-1">
              <Link
                href={`/settings/descriptors/${s.id}/edit`}
                className="font-medium hover:underline"
              >
                {s.criterionName}
              </Link>
              <p className="text-muted-foreground">
                {s.skillName} ({Math.round(s.similarity * 100)}% similar)
              </p>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

Create directory structure: `src/components/descriptors/`

Export both components for use in pages.
  </action>
  <verify>Run `npx tsc --noEmit` to verify components compile</verify>
  <done>Delete confirmation dialog with native dialog element, duplicate warning component ready for integration</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All TypeScript compiles without errors
2. Navigate to /settings/descriptors - list page loads
3. Click "Add Descriptor" - create page loads with form
4. Click edit on a descriptor - edit page loads with pre-populated form and duplicate warnings
5. Click delete - confirmation dialog appears
6. DuplicateWarning component renders when similar descriptors exist
7. All pages use consistent Card/Button/Input styling
8. Authorization enforced on all pages
</verification>

<success_criteria>
- [ ] /settings/descriptors page lists all descriptors with search and filters
- [ ] /settings/descriptors/create page has complete form for new descriptors
- [ ] /settings/descriptors/create page fetches and displays similar descriptors via DuplicateWarning
- [ ] /settings/descriptors/[id]/edit page pre-populates form for existing descriptor
- [ ] /settings/descriptors/[id]/edit page fetches and displays similar descriptors (excluding self)
- [ ] DeleteConfirmation component uses native dialog with Cancel/Delete buttons
- [ ] DeleteConfirmation uses absolute import path for deleteDescriptorAction
- [ ] DuplicateWarning component displays similar descriptors with links
- [ ] Error messages display from searchParams
- [ ] Success messages display for created/updated/deleted
- [ ] All pages enforce admin authorization
- [ ] Styling matches existing settings pages
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-curation/02-03-SUMMARY.md`
</output>
