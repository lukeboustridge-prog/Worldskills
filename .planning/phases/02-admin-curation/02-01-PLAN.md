---
phase: 02-admin-curation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/*_add_descriptor_curation/migration.sql
autonomous: true

must_haves:
  truths:
    - "Descriptor model has QualityIndicator enum field with EXCELLENT, GOOD, REFERENCE, NEEDS_REVIEW values"
    - "Descriptor model has soft delete fields (deletedAt, deletedBy)"
    - "pg_trgm extension is enabled for similarity matching"
    - "GIN index exists on tags array for efficient filtering"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "QualityIndicator enum, soft delete fields on Descriptor"
      contains: "enum QualityIndicator"
    - path: "prisma/migrations/*_add_descriptor_curation/migration.sql"
      provides: "Migration with pg_trgm extension, GIN indexes"
      contains: "CREATE EXTENSION IF NOT EXISTS pg_trgm"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Descriptor model"
      via: "QualityIndicator enum field"
      pattern: "qualityIndicator\\s+QualityIndicator"
---

<objective>
Add database schema extensions for descriptor curation: QualityIndicator enum, soft delete fields, pg_trgm extension for duplicate detection, and GIN index on tags array.

Purpose: Enable quality control classification, audit-trail-safe deletion, and efficient similarity matching for duplicate detection in the admin curation workflow.

Output: Updated Prisma schema with migration applied to database.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-curation/02-RESEARCH.md
@.planning/phases/01-data-import-foundation/01-01-SUMMARY.md

Reference existing Descriptor model:
- Located at end of prisma/schema.prisma
- Already has: id, code, criterionName, performance levels, source metadata, tags String[], version
- Already has: composite unique [skillName, code], B-tree indexes

Reference existing pattern for enum:
- ResourceCategory enum already exists in schema
- Role enum pattern shows how to define enums
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QualityIndicator enum and soft delete fields to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add after existing enums (after ResourceCategory):

```prisma
enum QualityIndicator {
  EXCELLENT      // Exemplary descriptor, showcase quality
  GOOD           // Solid descriptor, ready for use
  REFERENCE      // Use as reference, may need refinement
  NEEDS_REVIEW   // Imported, requires admin review
}
```

Update the Descriptor model to add:
1. `qualityIndicator QualityIndicator @default(NEEDS_REVIEW)` - after the version field
2. `deletedAt DateTime?` - for soft delete timestamp
3. `deletedBy String?` - for user who deleted (optional relation to User)

Do NOT add a User relation for deletedBy yet - keep it as simple String to avoid migration complexity. The relation can be added in a future phase if needed.

The Descriptor model should now include these new fields after the version field and before the audit timestamps:
```prisma
  // Quality control
  qualityIndicator QualityIndicator @default(NEEDS_REVIEW)

  // Soft delete
  deletedAt   DateTime?
  deletedBy   String?
```
  </action>
  <verify>Run `npx prisma validate` to ensure schema is valid</verify>
  <done>QualityIndicator enum defined with 4 values, Descriptor model has qualityIndicator, deletedAt, and deletedBy fields</done>
</task>

<task type="auto">
  <name>Task 2: Create migration with pg_trgm extension and GIN indexes</name>
  <files>prisma/migrations/*_add_descriptor_curation/migration.sql</files>
  <action>
Create migration using Prisma workflow. Due to non-interactive environment:

1. Generate migration SQL using `npx prisma migrate diff --from-schema-datamodel prisma/schema.prisma --to-schema-datamodel prisma/schema.prisma --script` or use `npx prisma migrate dev --name add_descriptor_curation --create-only` if available

2. If Prisma cannot create migration interactively, manually create:
   - Directory: `prisma/migrations/[timestamp]_add_descriptor_curation/`
   - File: `migration.sql`

3. The migration SQL MUST include:
   - pg_trgm extension: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`
   - Enum type creation: `CREATE TYPE "QualityIndicator" AS ENUM ('EXCELLENT', 'GOOD', 'REFERENCE', 'NEEDS_REVIEW');`
   - Add qualityIndicator column with default
   - Add deletedAt and deletedBy columns
   - GIN index on tags: `CREATE INDEX "Descriptor_tags_gin_idx" ON "Descriptor" USING GIN (tags);`
   - GIN index for trigram similarity on criterionName: `CREATE INDEX "Descriptor_criterionName_trgm_idx" ON "Descriptor" USING GIN ("criterionName" gin_trgm_ops);`

IMPORTANT: PostgreSQL requires enum type to exist before column using it. If migration fails with "type does not exist", split into two migrations: (1) create enum, (2) add column with default.

4. Apply migration: `npx prisma migrate deploy`

5. Regenerate Prisma Client: `npx prisma generate`
  </action>
  <verify>
Run these verification commands:
- `npx prisma migrate status` shows database is up to date
- `npx prisma db execute --stdin <<< "SELECT extname FROM pg_extension WHERE extname = 'pg_trgm';"` confirms pg_trgm is enabled
- `npx prisma db execute --stdin <<< "SELECT indexname FROM pg_indexes WHERE tablename = 'Descriptor' AND indexname LIKE '%gin%';"` confirms GIN indexes exist
  </verify>
  <done>Migration applied with pg_trgm extension enabled, GIN indexes on tags and criterionName for trigram search</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` - Schema is valid
2. `npx prisma migrate status` - Database schema is up to date
3. QualityIndicator enum exists in generated Prisma client types
4. Descriptor model has qualityIndicator, deletedAt, deletedBy fields
5. pg_trgm extension is installed in PostgreSQL
6. GIN indexes exist on Descriptor table for tags and criterionName
</verification>

<success_criteria>
- [ ] QualityIndicator enum with EXCELLENT, GOOD, REFERENCE, NEEDS_REVIEW values in schema
- [ ] Descriptor.qualityIndicator field with NEEDS_REVIEW default
- [ ] Descriptor.deletedAt and deletedBy fields for soft delete
- [ ] pg_trgm extension enabled in PostgreSQL
- [ ] GIN index on tags array field
- [ ] GIN trigram index on criterionName for similarity search
- [ ] All migrations applied successfully
- [ ] Prisma Client regenerated with new types
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-curation/02-01-SUMMARY.md`
</output>
