---
phase: 02-permission-business-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/permissions/meeting.ts
  - src/lib/email/meeting-invitation.ts
  - src/lib/activity.ts
autonomous: true

must_haves:
  truths:
    - "Permission check functions exist and can be imported"
    - "Email template differentiates skill vs management meetings"
    - "Activity logging accepts null skillId for management meetings"
  artifacts:
    - path: "src/lib/permissions/meeting.ts"
      provides: "Meeting permission check functions"
      exports: ["canCreateManagementMeeting", "canViewMeeting", "canManageMeeting"]
    - path: "src/lib/email/meeting-invitation.ts"
      provides: "Meeting invitation email with type support"
      contains: "meetingType"
    - path: "src/lib/activity.ts"
      provides: "Activity logging with optional skillId"
      contains: "skillId: string | null"
  key_links:
    - from: "src/lib/permissions/meeting.ts"
      to: "@prisma/client"
      via: "Role enum import"
      pattern: "import.*Role.*from.*@prisma/client"
    - from: "src/lib/email/meeting-invitation.ts"
      to: "sendEmail"
      via: "Resend email sending"
      pattern: "await sendEmail"
---

<objective>
Create the authorization foundation for management meetings: permission checking functions, email template support for meeting types, and activity logging that supports null skillId.

Purpose: Phase 2 requires role-based authorization (AUTH-01 to AUTH-06), email differentiation (EMAIL-04), and activity logging (SAFE-03). This plan creates the building blocks that Plan 02-02 will use.

Output: Three updated/new files providing reusable permission checks, meeting-type-aware email, and flexible activity logging.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-permission-&-business-logic-layer/02-RESEARCH.md

# Existing patterns to follow
@src/lib/auth.ts
@src/lib/email/meeting-invitation.ts
@src/lib/activity.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meeting permission helpers</name>
  <files>src/lib/permissions/meeting.ts</files>
  <action>
Create new file `src/lib/permissions/meeting.ts` with three permission check functions:

1. `canCreateManagementMeeting(user: { isAdmin: boolean; role: Role }): boolean`
   - Returns true if user.isAdmin OR user.role === Role.Secretariat
   - Simple synchronous function, no database query needed

2. `canViewMeeting(user, meeting, attendeeUserIds?): boolean`
   - For skill meetings (skillId !== null): return true (existing skill permission logic applies elsewhere)
   - For management meetings (skillId === null):
     - If user.role === Role.SA: return true (all SAs can view)
     - If user.role === Role.Secretariat: return attendeeUserIds?.includes(user.id) ?? false
     - If user.isAdmin: return true
     - Otherwise: return false

3. `canManageMeeting(user, meeting, skill?): boolean`
   - For management meetings (skillId === null):
     - Return true if user.isAdmin OR user.role === Role.Secretariat
   - For skill meetings:
     - Return existing canScheduleMeeting logic (admin, SA, SCM, team member)
     - Accepts optional skill object with saId, scmId, teamMembers

Import Role from @prisma/client. Use TypeScript interfaces for parameters (not importing full Prisma types to keep module lightweight).

Follow the pattern from research: pure functions that are testable and tree-shakeable.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check: No TypeScript errors
Check: File exists at src/lib/permissions/meeting.ts with all three exports
  </verify>
  <done>
Three permission functions exported: canCreateManagementMeeting, canViewMeeting, canManageMeeting. TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update email template for meeting type</name>
  <files>src/lib/email/meeting-invitation.ts</files>
  <action>
Modify `src/lib/email/meeting-invitation.ts` to support both skill and management meetings:

1. Update `MeetingDetails` interface:
   - Change `skillName: string` to `skillName?: string | null`
   - Add `meetingType?: "skill" | "management"` (default to "skill" if not provided for backward compatibility)

2. Update `sendMeetingInvitation` function:
   - Determine meeting type: if meetingType provided use it, else if skillName is null/undefined use "management", else "skill"
   - Subject line:
     - Skill: `Meeting Invitation: ${meeting.title} - ${meeting.skillName}`
     - Management: `Skill Advisor Meeting: ${meeting.title}`
   - Email header h1:
     - Skill: "Meeting Invitation"
     - Management: "Skill Advisor Meeting"
   - Skill line in body:
     - Skill: `Skill: <strong>${meeting.skillName}</strong>`
     - Management: `<strong>Management Meeting</strong>` (or omit this line)

3. Update `generateGoogleCalendarLink`:
   - Details field: use skillName if present, otherwise omit "Skill:" line

4. Update `generateICS`:
   - Description: use skillName if present, otherwise just "Management Meeting"

5. Update text version similarly.

Ensure backward compatibility: existing callers passing skillName will work unchanged.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check: No TypeScript errors
Check: sendMeetingInvitation accepts meeting with skillName: null
  </verify>
  <done>
Email template supports both meeting types. Skill meetings show "Meeting Invitation" with skill name. Management meetings show "Skill Advisor Meeting" without skill reference.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update activity logging for optional skillId</name>
  <files>src/lib/activity.ts</files>
  <action>
Modify `src/lib/activity.ts` to support management meetings which have no skillId:

1. Update `LogActivityParams` interface:
   - Change `skillId: string` to `skillId: string | null`

2. Update `logActivity` function:
   - Handle null skillId gracefully
   - Since ActivityLog.skillId is currently required in schema, use a workaround:
     - If skillId is null, use a sentinel value: "MANAGEMENT" (this is a temporary solution until schema migration)
     - Add a comment explaining this is temporary and should be migrated to optional skillId in future

Note: The schema has `skillId String` (required). We could migrate to optional, but that's a schema change. For Phase 2, use sentinel value approach as recommended in research. This keeps activity logging unified and queryable.

Alternative consideration: If time permits, add migration to make ActivityLog.skillId optional. But per research, sentinel value is acceptable for now.

Implementation:
```typescript
interface LogActivityParams {
  skillId: string | null;
  userId: string;
  action: string;
  payload?: Prisma.InputJsonValue;
}

export async function logActivity({
  skillId,
  userId,
  action,
  payload
}: LogActivityParams) {
  await prisma.activityLog.create({
    data: {
      // Use sentinel value for management meetings until schema migrated
      skillId: skillId ?? "MANAGEMENT",
      userId,
      action,
      payload: payload ?? Prisma.JsonNull
    }
  });
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check: No TypeScript errors
Check: logActivity accepts skillId: null
  </verify>
  <done>
Activity logging accepts null skillId using sentinel value "MANAGEMENT". Existing callers passing string skillId work unchanged.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` - TypeScript compilation passes
2. Files exist and export correct functions:
   - `src/lib/permissions/meeting.ts` exports canCreateManagementMeeting, canViewMeeting, canManageMeeting
   - `src/lib/email/meeting-invitation.ts` accepts meetingType parameter
   - `src/lib/activity.ts` accepts skillId: string | null
3. Existing code that imports these modules should not break (backward compatible)
</verification>

<success_criteria>
- [ ] Permission helper file created with three functions
- [ ] Email template supports meetingType parameter
- [ ] Activity logging accepts null skillId
- [ ] All TypeScript compilation passes
- [ ] No breaking changes to existing callers
</success_criteria>

<output>
After completion, create `.planning/phases/02-permission-&-business-logic-layer/02-01-SUMMARY.md`
</output>
