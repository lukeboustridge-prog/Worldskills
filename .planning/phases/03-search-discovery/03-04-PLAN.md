---
phase: 03-search-discovery
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/queries/related-descriptors.ts
  - scripts/test-related-descriptors.ts
autonomous: true

must_haves:
  truths:
    - "Related descriptors show similar criteria from other skills"
    - "Related descriptors are ranked by similarity score"
    - "Current descriptor is excluded from related results"
  artifacts:
    - path: "src/lib/queries/related-descriptors.ts"
      provides: "Related descriptor recommendations using pg_trgm similarity"
      exports: ["getRelatedDescriptors", "RelatedDescriptor"]
  key_links:
    - from: "src/lib/queries/related-descriptors.ts"
      to: "pg_trgm extension"
      via: "similarity() function"
      pattern: "similarity.*criterionName"
---

<objective>
Create related descriptors recommendation engine using pg_trgm trigram similarity

Purpose: Help users discover similar descriptors from other skills (SEARCH-08), enabling cross-skill pattern discovery
Output: getRelatedDescriptors query function using PostgreSQL similarity() with configurable threshold
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-search-discovery/03-RESEARCH.md

# Prior work
@.planning/phases/02-admin-curation/02-01-SUMMARY.md (pg_trgm extension already enabled)
@src/lib/duplicate-detection.ts (existing similarity pattern - different use case but similar technique)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create related descriptors query function</name>
  <files>src/lib/queries/related-descriptors.ts, scripts/test-related-descriptors.ts</files>
  <action>
Create `src/lib/queries/related-descriptors.ts` for finding similar descriptors:

```typescript
import { prisma } from "@/lib/prisma";
import { QualityIndicator } from "@prisma/client";

export interface RelatedDescriptor {
  id: string;
  code: string;
  criterionName: string;
  skillName: string;
  sector: string | null;
  category: string | null;
  qualityIndicator: QualityIndicator;
  similarityScore: number;
}

/**
 * Find descriptors with similar criterion names using pg_trgm similarity.
 * Useful for "Related descriptors" recommendations and cross-skill discovery.
 *
 * @param descriptorId - ID of the source descriptor
 * @param limit - Maximum results to return (default 5)
 * @param similarityThreshold - Minimum similarity score 0-1 (default 0.3)
 * @returns Related descriptors ordered by similarity DESC
 */
export async function getRelatedDescriptors(
  descriptorId: string,
  limit: number = 5,
  similarityThreshold: number = 0.3
): Promise<RelatedDescriptor[]> {
  return prisma.$queryRaw<RelatedDescriptor[]>`
    SELECT
      d2.id,
      d2.code,
      d2."criterionName",
      d2."skillName",
      d2.sector,
      d2.category,
      d2."qualityIndicator",
      similarity(d1."criterionName", d2."criterionName") as "similarityScore"
    FROM "Descriptor" d1
    CROSS JOIN LATERAL (
      SELECT *
      FROM "Descriptor"
      WHERE id != ${descriptorId}
        AND "deletedAt" IS NULL
        AND similarity("criterionName", d1."criterionName") > ${similarityThreshold}
      ORDER BY similarity("criterionName", d1."criterionName") DESC
      LIMIT ${limit}
    ) d2
    WHERE d1.id = ${descriptorId}
      AND d1."deletedAt" IS NULL
    ORDER BY "similarityScore" DESC
  `;
}

/**
 * Find related descriptors by criterion name text (for use during creation).
 * Useful when descriptor doesn't exist yet but we want to show related items.
 *
 * @param criterionName - The criterion name text to match against
 * @param limit - Maximum results to return (default 5)
 * @param similarityThreshold - Minimum similarity score 0-1 (default 0.3)
 * @param excludeId - Optional ID to exclude (for edit mode)
 */
export async function getRelatedByCriterionName(
  criterionName: string,
  limit: number = 5,
  similarityThreshold: number = 0.3,
  excludeId?: string
): Promise<RelatedDescriptor[]> {
  if (!criterionName || criterionName.length < 5) {
    return [];
  }

  if (excludeId) {
    return prisma.$queryRaw<RelatedDescriptor[]>`
      SELECT
        id,
        code,
        "criterionName",
        "skillName",
        sector,
        category,
        "qualityIndicator",
        similarity("criterionName", ${criterionName}) as "similarityScore"
      FROM "Descriptor"
      WHERE "deletedAt" IS NULL
        AND id != ${excludeId}
        AND similarity("criterionName", ${criterionName}) > ${similarityThreshold}
      ORDER BY "similarityScore" DESC
      LIMIT ${limit}
    `;
  }

  return prisma.$queryRaw<RelatedDescriptor[]>`
    SELECT
      id,
      code,
      "criterionName",
      "skillName",
      sector,
      category,
      "qualityIndicator",
      similarity("criterionName", ${criterionName}) as "similarityScore"
    FROM "Descriptor"
    WHERE "deletedAt" IS NULL
      AND similarity("criterionName", ${criterionName}) > ${similarityThreshold}
    ORDER BY "similarityScore" DESC
    LIMIT ${limit}
  `;
}
```

Key implementation notes:
- Uses CROSS JOIN LATERAL for efficient "top-N per row" query pattern
- pg_trgm similarity() function returns 0-1 score
- Default threshold 0.3 is pg_trgm default, tune based on user feedback
- Excludes soft-deleted descriptors
- Returns skill context (skillName, sector) for cross-skill discovery
- Two functions: by ID (for detail view) and by text (for create/edit forms)

Then create a standalone test script at `scripts/test-related-descriptors.ts`:

```typescript
import { PrismaClient } from "@prisma/client";
import { getRelatedDescriptors, getRelatedByCriterionName } from "../src/lib/queries/related-descriptors";

const prisma = new PrismaClient();

async function test() {
  console.log("Testing related descriptors functions...\n");

  // Get a random descriptor
  const sample = await prisma.descriptor.findFirst({
    where: { deletedAt: null },
    select: { id: true, criterionName: true, skillName: true }
  });

  if (!sample) {
    console.log("No descriptors found");
    process.exit(1);
  }

  console.log("Source descriptor:");
  console.log("  Criterion:", sample.criterionName);
  console.log("  Skill:", sample.skillName);
  console.log("");

  // Test by ID
  const relatedById = await getRelatedDescriptors(sample.id);
  console.log("Related by ID:", relatedById.length, "results");
  relatedById.forEach(r => {
    console.log("  -", r.similarityScore.toFixed(2), r.skillName, "-", r.criterionName.substring(0, 50));
  });
  console.log("");

  // Test by text
  const relatedByText = await getRelatedByCriterionName(sample.criterionName);
  console.log("Related by text:", relatedByText.length, "results");

  if (relatedById.length > 0) {
    console.log("\n✓ Related descriptors function works");
  } else {
    console.log("\n⚠ No related descriptors found (may need lower threshold)");
  }
}

test()
  .catch((err) => {
    console.error("Test failed:", err);
    process.exit(1);
  })
  .finally(() => prisma.$disconnect());
```
  </action>
  <verify>
Run: `npx ts-node scripts/test-related-descriptors.ts`
Should show source descriptor, related results, and success message.
  </verify>
  <done>getRelatedDescriptors and getRelatedByCriterionName functions created, using pg_trgm similarity with configurable threshold</done>
</task>

<task type="auto">
  <name>Task 2: Verify GIN index for similarity queries</name>
  <files>None (verification only)</files>
  <action>
Confirm that the pg_trgm GIN index from Phase 2 (02-01) is being used for similarity queries:

1. Check the index exists:
```sql
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'Descriptor'
AND indexname LIKE '%trgm%';
```

2. Run EXPLAIN on a similarity query:
```sql
EXPLAIN ANALYZE
SELECT id, similarity("criterionName", 'safety measurement') as sim
FROM "Descriptor"
WHERE similarity("criterionName", 'safety measurement') > 0.3
ORDER BY sim DESC
LIMIT 5;
```

The plan should show "Bitmap Index Scan on idx_descriptors_trgm" for the similarity condition.

If the index is not being used:
- Verify the index was created correctly in Phase 2 migration
- Check if similarity threshold is too low (might cause full table scan)
- Consider adding `SET pg_trgm.similarity_threshold = 0.3;` before query

Note: For small tables (<10K rows), PostgreSQL might choose sequential scan anyway due to cost estimation. This is acceptable for our ~12K corpus.
  </action>
  <verify>
EXPLAIN shows index usage OR shows acceptable sequential scan performance (<50ms for similarity queries).
  </verify>
  <done>pg_trgm index confirmed or acceptable performance verified for similarity queries</done>
</task>

<task type="auto">
  <name>Task 3: Test cross-skill discovery use case</name>
  <files>scripts/test-cross-skill-discovery.ts</files>
  <action>
Validate the cross-skill discovery feature by creating and running a test script.

Create `scripts/test-cross-skill-discovery.ts`:

```typescript
import { PrismaClient } from "@prisma/client";
import { getRelatedDescriptors } from "../src/lib/queries/related-descriptors";

const prisma = new PrismaClient();

async function test() {
  console.log("Testing cross-skill discovery...\n");

  // Find a 'safety' descriptor
  const safety = await prisma.descriptor.findFirst({
    where: {
      deletedAt: null,
      criterionName: { contains: "safety", mode: "insensitive" }
    },
    select: { id: true, criterionName: true, skillName: true }
  });

  if (!safety) {
    console.log("No safety descriptor found");
    process.exit(1);
  }

  console.log("Source safety descriptor:");
  console.log("  Skill:", safety.skillName);
  console.log("  Criterion:", safety.criterionName);

  const related = await getRelatedDescriptors(safety.id, 10, 0.25);
  console.log("\nRelated descriptors from OTHER skills:");

  const otherSkills = related.filter(r => r.skillName !== safety.skillName);
  otherSkills.forEach(r => {
    console.log("  -", r.skillName, ":", r.criterionName.substring(0, 60), "(", r.similarityScore.toFixed(2), ")");
  });

  console.log("\nCross-skill discovery:", otherSkills.length > 0 ? "WORKING" : "NO RESULTS");

  if (otherSkills.length > 0) {
    console.log("\n✓ Cross-skill discovery validated");
  } else {
    console.log("\n⚠ No cross-skill results (may need more data or lower threshold)");
  }
}

test()
  .catch((err) => {
    console.error("Test failed:", err);
    process.exit(1);
  })
  .finally(() => prisma.$disconnect());
```

Run: `npx ts-node scripts/test-cross-skill-discovery.ts`

This validates the primary use case: "See how other skills describe safety" from SEARCH-08 requirement.
  </action>
  <verify>
Run: `npx ts-node scripts/test-cross-skill-discovery.ts`
At least one related descriptor is found from a DIFFERENT skill than the source.
  </verify>
  <done>Cross-skill discovery validated - related descriptors include similar criteria from other skills</done>
</task>

</tasks>

<verification>
1. getRelatedDescriptors returns similar descriptors excluding source
2. getRelatedByCriterionName works for text-based matching (create/edit use case)
3. Similarity scores in expected 0.3-1.0 range
4. Results include descriptors from other skills (cross-skill discovery)
5. Performance acceptable (<100ms for similarity queries)
</verification>

<success_criteria>
- Related descriptors function returns ranked similar items
- Current descriptor excluded from related results
- Cross-skill discovery works (finds similar criteria across different skills)
- pg_trgm index used or acceptable performance without it
- Similarity threshold configurable (default 0.3)
</success_criteria>

<output>
After completion, create `.planning/phases/03-search-discovery/03-04-SUMMARY.md`
</output>
