---
phase: 03-search-discovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/YYYYMMDDHHMMSS_add_descriptor_favorites/migration.sql
  - src/lib/actions/toggle-favorite.ts
  - src/lib/queries/get-favorites.ts
autonomous: true

must_haves:
  truths:
    - "User can bookmark a descriptor for quick access"
    - "User can view their bookmarked descriptors"
    - "Bookmark toggle is idempotent (add if not exists, remove if exists)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "DescriptorFavorite junction table model"
      contains: "model DescriptorFavorite"
    - path: "src/lib/actions/toggle-favorite.ts"
      provides: "Server Action for toggling favorites"
      exports: ["toggleFavorite"]
    - path: "src/lib/queries/get-favorites.ts"
      provides: "Query functions for user favorites"
      exports: ["getUserFavorites", "isFavorited"]
  key_links:
    - from: "DescriptorFavorite"
      to: "User"
      via: "userId foreign key with cascade delete"
      pattern: "@relation.*userId.*onDelete: Cascade"
    - from: "DescriptorFavorite"
      to: "Descriptor"
      via: "descriptorId foreign key with cascade delete"
      pattern: "@relation.*descriptorId.*onDelete: Cascade"
---

<objective>
Create user bookmark/favorites system for descriptors with junction table schema and Server Actions

Purpose: Enable users to save frequently accessed descriptors for quick retrieval (SEARCH-07)
Output: DescriptorFavorite schema, toggle Server Action, query functions for favorites
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-search-discovery/03-RESEARCH.md

# Prior work reference
@prisma/schema.prisma
@src/lib/auth.ts (auth pattern for session access)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DescriptorFavorite junction table to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add a new DescriptorFavorite model to prisma/schema.prisma for the many-to-many relationship between User and Descriptor.

Add to User model (inside the model block, after existing relations):
```prisma
  favoriteDescriptors DescriptorFavorite[]
```

Add to Descriptor model (inside the model block, after existing fields):
```prisma
  // User favorites
  favoritedBy DescriptorFavorite[]
```

Add new model at the end of schema.prisma:
```prisma
model DescriptorFavorite {
  userId       String
  descriptorId String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  descriptor Descriptor @relation(fields: [descriptorId], references: [id], onDelete: Cascade)

  @@id([userId, descriptorId])
  @@index([userId])
  @@index([descriptorId])
}
```

Key design decisions:
- Composite primary key [userId, descriptorId] prevents duplicates
- Cascade delete on both relations (if user or descriptor deleted, favorites cleaned up)
- createdAt for ordering favorites by recency
- Indexes on both foreign keys for efficient queries
  </action>
  <verify>
Run `npx prisma validate` - should complete without errors.
Run `npx prisma format` to ensure consistent formatting.
  </verify>
  <done>DescriptorFavorite model added with relations to User and Descriptor, cascade deletes configured</done>
</task>

<task type="auto">
  <name>Task 2: Create migration and apply schema changes</name>
  <files>prisma/migrations/YYYYMMDDHHMMSS_add_descriptor_favorites/migration.sql</files>
  <action>
Generate and apply the migration:

```bash
npx prisma migrate dev --name add_descriptor_favorites
```

Verify the migration SQL creates:
1. DescriptorFavorite table with composite primary key
2. Foreign key constraints with ON DELETE CASCADE
3. Indexes on userId and descriptorId

The generated migration should contain something like:
```sql
CREATE TABLE "DescriptorFavorite" (
    "userId" TEXT NOT NULL,
    "descriptorId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "DescriptorFavorite_pkey" PRIMARY KEY ("userId","descriptorId")
);

CREATE INDEX "DescriptorFavorite_userId_idx" ON "DescriptorFavorite"("userId");
CREATE INDEX "DescriptorFavorite_descriptorId_idx" ON "DescriptorFavorite"("descriptorId");

ALTER TABLE "DescriptorFavorite" ADD CONSTRAINT "DescriptorFavorite_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "DescriptorFavorite" ADD CONSTRAINT "DescriptorFavorite_descriptorId_fkey" FOREIGN KEY ("descriptorId") REFERENCES "Descriptor"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```
  </action>
  <verify>
Run `npx prisma migrate status` - migration should be applied.
Run `npx prisma db execute --stdin <<< "SELECT * FROM \"DescriptorFavorite\" LIMIT 1;"` - table should exist (empty result OK).
  </verify>
  <done>Migration created and applied, DescriptorFavorite table exists in database</done>
</task>

<task type="auto">
  <name>Task 3: Create toggle favorite Server Action and query functions</name>
  <files>src/lib/actions/toggle-favorite.ts, src/lib/queries/get-favorites.ts</files>
  <action>
Create `src/lib/actions/toggle-favorite.ts`:

```typescript
"use server";

import { prisma } from "@/lib/prisma";
import { auth } from "@/lib/auth";
import { revalidatePath } from "next/cache";

export async function toggleFavorite(descriptorId: string) {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  const userId = session.user.id;

  // Check if already favorited
  const existing = await prisma.descriptorFavorite.findUnique({
    where: {
      userId_descriptorId: {
        userId,
        descriptorId,
      },
    },
  });

  if (existing) {
    // Remove favorite
    await prisma.descriptorFavorite.delete({
      where: {
        userId_descriptorId: {
          userId,
          descriptorId,
        },
      },
    });
  } else {
    // Add favorite
    await prisma.descriptorFavorite.create({
      data: {
        userId,
        descriptorId,
      },
    });
  }

  revalidatePath("/descriptors");
  return { success: true, isFavorited: !existing };
}
```

Create `src/lib/queries/get-favorites.ts`:

```typescript
import { prisma } from "@/lib/prisma";

/**
 * Get all favorited descriptors for a user.
 * Returns descriptors ordered by when they were favorited (most recent first).
 */
export async function getUserFavorites(userId: string) {
  const favorites = await prisma.descriptorFavorite.findMany({
    where: { userId },
    include: {
      descriptor: true,
    },
    orderBy: { createdAt: "desc" },
  });

  // Filter out favorites where descriptor was soft-deleted
  return favorites
    .filter((f) => f.descriptor.deletedAt === null)
    .map((f) => f.descriptor);
}

/**
 * Check if a specific descriptor is favorited by user.
 */
export async function isFavorited(
  userId: string,
  descriptorId: string
): Promise<boolean> {
  const favorite = await prisma.descriptorFavorite.findUnique({
    where: {
      userId_descriptorId: {
        userId,
        descriptorId,
      },
    },
  });
  return favorite !== null;
}

/**
 * Check favorite status for multiple descriptors at once.
 * Returns a Set of descriptor IDs that are favorited.
 */
export async function getFavoriteIds(userId: string): Promise<Set<string>> {
  const favorites = await prisma.descriptorFavorite.findMany({
    where: { userId },
    select: { descriptorId: true },
  });
  return new Set(favorites.map((f) => f.descriptorId));
}
```

Key implementation notes:
- toggleFavorite is idempotent: add if not exists, remove if exists
- Uses composite key lookup for efficient single-row operations
- Returns isFavorited boolean so UI can update optimistically
- getUserFavorites filters out soft-deleted descriptors
- getFavoriteIds is optimized for checking multiple descriptors (e.g., search results list)
  </action>
  <verify>
TypeScript compilation: `npx tsc --noEmit`
Verify files exist and exports are correct.
  </verify>
  <done>toggleFavorite Server Action created, getUserFavorites and isFavorited query functions created, getFavoriteIds batch function created</done>
</task>

</tasks>

<verification>
1. Schema valid: `npx prisma validate`
2. Migration applied: `npx prisma migrate status`
3. TypeScript compiles: `npx tsc --noEmit`
4. Table exists: Query DescriptorFavorite table
5. Server Action has auth check: Code review shows session validation
</verification>

<success_criteria>
- DescriptorFavorite junction table created with proper relations
- Migration applied successfully
- toggleFavorite Server Action with auth validation
- Query functions for getting user favorites
- Cascade deletes configured for both User and Descriptor
</success_criteria>

<output>
After completion, create `.planning/phases/03-search-discovery/03-02-SUMMARY.md`
</output>
