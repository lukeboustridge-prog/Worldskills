---
phase: 07-scm-descriptor-creation-batch-workflow
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/scm-descriptors.ts
autonomous: true

must_haves:
  truths:
    - "getSCMDescriptors returns all descriptors created by a specific user"
    - "getDraftDescriptors returns only DRAFT status descriptors for a user"
    - "Descriptors include wsosSection relation for display"
    - "Results ordered by batchStatus then updatedAt"
  artifacts:
    - path: "src/lib/scm-descriptors.ts"
      provides: "SCM descriptor query utilities"
      exports: ["getSCMDescriptors", "getDraftDescriptors", "getSCMDescriptorById"]
  key_links:
    - from: "src/lib/scm-descriptors.ts"
      to: "prisma.descriptor"
      via: "Prisma queries"
      pattern: "prisma\\.descriptor\\.find"
---

<objective>
Create query utilities for SCM descriptor workflow to fetch descriptors by creator and batch status.

Purpose: Provide data access functions for the SCM "My Descriptors" page, filtering by createdById and batchStatus.

Output: src/lib/scm-descriptors.ts with query functions for SCM descriptor management.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-scm-descriptor-creation-batch-workflow/07-RESEARCH.md
@.planning/phases/07-scm-descriptor-creation-batch-workflow/07-01-SUMMARY.md
@src/lib/wsos-sections.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SCM descriptor query utilities</name>
  <files>src/lib/scm-descriptors.ts</files>
  <action>
Create new file `src/lib/scm-descriptors.ts` with the following functions:

```typescript
import { DescriptorBatchStatus } from "@prisma/client";
import { prisma } from "@/lib/prisma";

/**
 * Get all descriptors created by an SCM, with batch status grouping.
 * Includes wsosSection for display.
 *
 * @param userId - The SCM's user ID
 * @returns Descriptors ordered by batchStatus (DRAFT first) then updatedAt DESC
 */
export async function getSCMDescriptors(userId: string) {
  return prisma.descriptor.findMany({
    where: {
      createdById: userId,
      deletedAt: null,
    },
    include: {
      wsosSection: {
        select: {
          id: true,
          name: true,
        },
      },
    },
    orderBy: [
      { batchStatus: "asc" }, // DRAFT < PENDING_REVIEW < APPROVED < RETURNED
      { updatedAt: "desc" },
    ],
  });
}

export type SCMDescriptor = Awaited<ReturnType<typeof getSCMDescriptors>>[number];

/**
 * Get only DRAFT descriptors for an SCM (not yet submitted).
 * Used for the "Draft Batch" section of My Descriptors page.
 *
 * @param userId - The SCM's user ID
 * @returns Draft descriptors ordered by createdAt DESC (newest first)
 */
export async function getDraftDescriptors(userId: string) {
  return prisma.descriptor.findMany({
    where: {
      createdById: userId,
      batchStatus: DescriptorBatchStatus.DRAFT,
      deletedAt: null,
    },
    include: {
      wsosSection: {
        select: {
          id: true,
          name: true,
        },
      },
    },
    orderBy: { createdAt: "desc" },
  });
}

/**
 * Get a single descriptor by ID, but only if created by the specified user.
 * Used for edit page authorization.
 *
 * @param id - Descriptor ID
 * @param userId - The SCM's user ID (must match createdById)
 * @returns Descriptor or null if not found/not owned by user
 */
export async function getSCMDescriptorById(id: string, userId: string) {
  return prisma.descriptor.findFirst({
    where: {
      id,
      createdById: userId,
      deletedAt: null,
    },
    include: {
      wsosSection: {
        select: {
          id: true,
          name: true,
        },
      },
    },
  });
}

/**
 * Count descriptors by batch status for an SCM.
 * Used for dashboard summary or badge counts.
 *
 * @param userId - The SCM's user ID
 * @returns Object with counts per status
 */
export async function getSCMDescriptorCounts(userId: string) {
  const results = await prisma.descriptor.groupBy({
    by: ["batchStatus"],
    where: {
      createdById: userId,
      deletedAt: null,
    },
    _count: true,
  });

  // Convert to a more usable format
  const counts: Record<string, number> = {
    DRAFT: 0,
    PENDING_REVIEW: 0,
    APPROVED: 0,
    RETURNED: 0,
  };

  for (const result of results) {
    if (result.batchStatus) {
      counts[result.batchStatus] = result._count;
    }
  }

  return counts;
}
```

IMPORTANT:
- Always filter by `createdById: userId` to ensure SCMs only see their own descriptors
- Always filter by `deletedAt: null` to exclude soft-deleted
- Include wsosSection for display purposes (section name shown on list)
- batchStatus ordering: DRAFT first (so draft batch appears at top)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Verify exports are correct by checking file exports all 4 functions.
  </verify>
  <done>
src/lib/scm-descriptors.ts created with:
- getSCMDescriptors(userId) - all descriptors for user
- getDraftDescriptors(userId) - only DRAFT status
- getSCMDescriptorById(id, userId) - single descriptor with ownership check
- getSCMDescriptorCounts(userId) - counts by status
- SCMDescriptor type exported
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- [ ] File exists at src/lib/scm-descriptors.ts
- [ ] `npx tsc --noEmit` passes
- [ ] All 4 functions exported
- [ ] SCMDescriptor type exported
- [ ] All queries filter by createdById and deletedAt: null
</verification>

<success_criteria>
- getSCMDescriptors returns descriptors filtered by createdById with wsosSection included
- getDraftDescriptors returns only DRAFT status descriptors
- getSCMDescriptorById returns single descriptor with ownership check
- getSCMDescriptorCounts returns counts grouped by batchStatus
- All queries properly filter soft-deleted records
</success_criteria>

<output>
After completion, create `.planning/phases/07-scm-descriptor-creation-batch-workflow/07-02-SUMMARY.md`
</output>
