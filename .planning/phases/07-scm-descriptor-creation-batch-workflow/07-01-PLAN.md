---
phase: 07-scm-descriptor-creation-batch-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Descriptor model has wsosSection relation for linking to WSOS sections"
    - "Descriptor model has batch workflow fields (batchStatus, batchId, submittedAt)"
    - "Descriptor model tracks creator (createdById) and reviewer (reviewerId)"
    - "DescriptorBatchStatus enum exists with DRAFT, PENDING_REVIEW, APPROVED, RETURNED values"
    - "WSOSSection model has inverse descriptors relation"
    - "User model has descriptor relations for creator and reviewer"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended Descriptor model with batch workflow fields"
      contains: "enum DescriptorBatchStatus"
  key_links:
    - from: "Descriptor.wsosSectionId"
      to: "WSOSSection.id"
      via: "foreign key relation"
      pattern: "wsosSection\\s+WSOSSection"
    - from: "Descriptor.createdById"
      to: "User.id"
      via: "foreign key relation"
      pattern: "createdBy\\s+User"
---

<objective>
Extend the Descriptor model with WSOS section linking and batch workflow fields for SCM descriptor creation.

Purpose: Enable SCM-created descriptors to link to WSOS sections and track their approval workflow status (DRAFT -> PENDING_REVIEW -> APPROVED/RETURNED).

Output: Updated Prisma schema with DescriptorBatchStatus enum and extended Descriptor model ready for SCM workflow.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-scm-descriptor-creation-batch-workflow/07-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DescriptorBatchStatus enum and extend Descriptor model</name>
  <files>prisma/schema.prisma</files>
  <action>
1. Add new enum DescriptorBatchStatus BEFORE the Descriptor model:
```prisma
enum DescriptorBatchStatus {
  DRAFT           // SCM creating, not yet submitted
  PENDING_REVIEW  // Submitted to SA, awaiting approval
  APPROVED        // SA approved (qualityIndicator set to GOOD)
  RETURNED        // SA returned with comments, SCM can revise
}
```

2. Add new fields to the Descriptor model (after the existing favoritedBy relation):
```prisma
  // WSOS Section linking (required for SCM-created descriptors)
  wsosSectionId String?
  wsosSection   WSOSSection? @relation(fields: [wsosSectionId], references: [id])

  // Batch workflow fields
  batchStatus   DescriptorBatchStatus?  // null for admin/imported descriptors
  batchId       String?                  // Groups descriptors in same submission
  createdById   String?                  // SCM who created (null for imported)
  createdBy     User?                    @relation("DescriptorCreator", fields: [createdById], references: [id])
  submittedAt   DateTime?                // When batch was submitted
  reviewerId    String?                  // SA who reviewed
  reviewer      User?                    @relation("DescriptorReviewer", fields: [reviewerId], references: [id])
  reviewedAt    DateTime?                // When review completed
  reviewComment String?                  @db.Text  // SA's feedback if returned
```

3. Add indexes for the new fields (inside Descriptor model):
```prisma
  @@index([wsosSectionId])
  @@index([batchStatus])
  @@index([batchId])
  @@index([createdById])
```

4. Add inverse relation to WSOSSection model:
```prisma
  descriptors Descriptor[]
```

5. Add relations to User model (after existing createdWSOSSections):
```prisma
  descriptorsCreated  Descriptor[] @relation("DescriptorCreator")
  descriptorsReviewed Descriptor[] @relation("DescriptorReviewer")
```

IMPORTANT:
- Place new Descriptor fields after the existing `favoritedBy` relation, before the existing indexes
- The existing `@@index([source])`, `@@index([sector])`, `@@index([version])` stay in place
- Do NOT remove any existing fields - this is additive only
  </action>
  <verify>
Run `npx prisma validate` to verify schema is valid.
Run `npx prisma format` to ensure proper formatting.
  </verify>
  <done>
Prisma schema validates successfully with:
- DescriptorBatchStatus enum with DRAFT, PENDING_REVIEW, APPROVED, RETURNED
- Descriptor has wsosSectionId, batchStatus, batchId, createdById, submittedAt, reviewerId, reviewedAt, reviewComment fields
- Descriptor has wsosSection, createdBy, reviewer relations
- WSOSSection has descriptors inverse relation
- User has descriptorsCreated, descriptorsReviewed relations
- All new indexes created
  </done>
</task>

<task type="auto">
  <name>Task 2: Create and apply database migration</name>
  <files>prisma/migrations/</files>
  <action>
1. Generate migration with Prisma:
```bash
npx prisma migrate dev --name descriptor_batch_workflow
```

2. Verify migration was created in prisma/migrations/ directory

3. Verify Prisma Client was regenerated (happens automatically with migrate dev)

IMPORTANT:
- Migration should be backward compatible (all new fields are nullable)
- Existing descriptors will have null for all new fields (correct - they are imported/admin-created)
- Do NOT modify existing data
  </action>
  <verify>
Run `npx prisma migrate status` to verify migration applied.
Run `npx prisma generate` to confirm client regenerated.
Check that dev server starts without errors: `npm run dev` (start and immediately stop).
  </verify>
  <done>
Migration created and applied successfully:
- No errors during migration
- Prisma Client regenerated with new types (DescriptorBatchStatus, extended Descriptor)
- Dev server starts without TypeScript errors
  </done>
</task>

</tasks>

<verification>
- [ ] `npx prisma validate` passes
- [ ] Migration created in prisma/migrations/
- [ ] `npx prisma migrate status` shows all migrations applied
- [ ] `npx tsc --noEmit` passes (TypeScript compiles)
- [ ] Dev server starts without errors
</verification>

<success_criteria>
- DescriptorBatchStatus enum exists with 4 values (DRAFT, PENDING_REVIEW, APPROVED, RETURNED)
- Descriptor model has all 9 new fields (wsosSectionId, wsosSection, batchStatus, batchId, createdById, createdBy, submittedAt, reviewerId, reviewer, reviewedAt, reviewComment)
- WSOSSection has descriptors relation
- User has descriptorsCreated and descriptorsReviewed relations
- Database migration applied successfully
- Existing descriptors unaffected (null values for new fields)
</success_criteria>

<output>
After completion, create `.planning/phases/07-scm-descriptor-creation-batch-workflow/07-01-SUMMARY.md`
</output>
