---
phase: 07-scm-descriptor-creation-batch-workflow
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
autonomous: true

must_haves:
  truths:
    - "SCM can create descriptor with mandatory wsosSectionId"
    - "New descriptors automatically get NEEDS_REVIEW quality and DRAFT batch status"
    - "SCM can update only their own DRAFT descriptors"
    - "SCM can delete only their own DRAFT descriptors"
    - "submitBatchAction changes all DRAFT to PENDING_REVIEW with same batchId"
  artifacts:
    - path: "src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts"
      provides: "SCM descriptor Server Actions"
      exports: ["createSCMDescriptorAction", "updateSCMDescriptorAction", "deleteSCMDescriptorAction", "submitBatchAction"]
  key_links:
    - from: "src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts"
      to: "prisma.descriptor"
      via: "Prisma create/update/delete"
      pattern: "prisma\\.descriptor\\.(create|update|delete)"
---

<objective>
Create Server Actions for SCM descriptor CRUD and batch submission workflow.

Purpose: Enable SCMs to create, edit, delete draft descriptors and submit batches for SA review.

Output: Server Actions file at src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-scm-descriptor-creation-batch-workflow/07-RESEARCH.md
@.planning/phases/07-scm-descriptor-creation-batch-workflow/07-01-SUMMARY.md
@src/app/(dashboard)/settings/descriptors/actions.ts
@src/app/(dashboard)/settings/wsos-sections/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure</name>
  <files>src/app/(dashboard)/hub/descriptors/my-descriptors/</files>
  <action>
Create the directory structure for SCM descriptor pages:
```bash
mkdir -p src/app/(dashboard)/hub/descriptors/my-descriptors
```

This will hold:
- actions.ts (this plan)
- page.tsx (plan 04)
- create/page.tsx (plan 04)
- [id]/edit/page.tsx (plan 04)
  </action>
  <verify>Directory exists at src/app/(dashboard)/hub/descriptors/my-descriptors/</verify>
  <done>Directory created</done>
</task>

<task type="auto">
  <name>Task 2: Create SCM descriptor Server Actions</name>
  <files>src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts</files>
  <action>
Create new file `src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts`:

```typescript
"use server";

import { DescriptorBatchStatus, QualityIndicator } from "@prisma/client";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { z } from "zod";

import { requireUser } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

// Helper to parse comma-separated string into array
function parseCommaSeparated(input: string | undefined): string[] {
  if (!input) return [];
  return input
    .split(",")
    .map((item) => item.trim())
    .filter((item) => item.length > 0);
}

// Create schema - wsosSectionId is REQUIRED for SCM (DESC-02)
const createSCMDescriptorSchema = z.object({
  code: z.string().min(1, "Code is required"),
  criterionName: z.string().min(5, "Criterion name must be at least 5 characters"),
  wsosSectionId: z.string().min(1, "WSOS section is required"),
  score3: z.string().optional(),
  score2: z.string().optional(),
  score1: z.string().optional(),
  score0: z.string().optional(),
  tags: z.string().optional(),
}).refine(
  (data) => data.score3 || data.score2 || data.score1 || data.score0,
  { message: "At least one performance level description is required" }
);

// Update schema - same as create but with id
const updateSCMDescriptorSchema = createSCMDescriptorSchema.extend({
  id: z.string().min(1, "Descriptor ID is required"),
});

/**
 * Create a new descriptor as SCM.
 * Automatically sets:
 * - qualityIndicator: NEEDS_REVIEW (DESC-04)
 * - batchStatus: DRAFT (BATCH-01)
 * - source: "SCM"
 * - createdById: current user
 */
export async function createSCMDescriptorAction(formData: FormData) {
  const user = await requireUser();

  // Only SCMs can create through this action
  if (user.role !== "SCM") {
    throw new Error("Only SCMs can create descriptors through this interface");
  }

  const parsed = createSCMDescriptorSchema.safeParse({
    code: formData.get("code"),
    criterionName: formData.get("criterionName"),
    wsosSectionId: formData.get("wsosSectionId"),
    score3: formData.get("score3") || undefined,
    score2: formData.get("score2") || undefined,
    score1: formData.get("score1") || undefined,
    score0: formData.get("score0") || undefined,
    tags: formData.get("tags") || undefined,
  });

  if (!parsed.success) {
    const error = parsed.error.errors[0]?.message ?? "Invalid input";
    const params = new URLSearchParams({ error });
    return redirect(`/hub/descriptors/my-descriptors/create?${params.toString()}`);
  }

  const data = parsed.data;
  const tags = parseCommaSeparated(data.tags);

  try {
    // Use raw SQL to handle text[] array type properly
    await prisma.$executeRaw`
      INSERT INTO "Descriptor" (
        id, code, "criterionName", score3, score2, score1, score0,
        "wsosSectionId", tags, "qualityIndicator", "batchStatus",
        source, "createdById", version, "createdAt", "updatedAt"
      ) VALUES (
        gen_random_uuid()::text,
        ${data.code.trim()},
        ${data.criterionName.trim()},
        ${data.score3?.trim() || null},
        ${data.score2?.trim() || null},
        ${data.score1?.trim() || null},
        ${data.score0?.trim() || null},
        ${data.wsosSectionId},
        ${tags}::text[],
        ${QualityIndicator.NEEDS_REVIEW}::"QualityIndicator",
        ${DescriptorBatchStatus.DRAFT}::"DescriptorBatchStatus",
        'SCM',
        ${user.id},
        1,
        NOW(),
        NOW()
      )
    `;
  } catch (error) {
    console.error("Failed to create descriptor", error);
    const params = new URLSearchParams({ error: "Failed to create descriptor" });
    return redirect(`/hub/descriptors/my-descriptors/create?${params.toString()}`);
  }

  revalidatePath("/hub/descriptors/my-descriptors");
  const params = new URLSearchParams({ created: "1" });
  return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
}

/**
 * Update an SCM's draft descriptor.
 * Only allowed if:
 * - Descriptor exists and is owned by current user (createdById)
 * - Descriptor is in DRAFT status
 */
export async function updateSCMDescriptorAction(formData: FormData) {
  const user = await requireUser();

  if (user.role !== "SCM") {
    throw new Error("Only SCMs can update descriptors through this interface");
  }

  const parsed = updateSCMDescriptorSchema.safeParse({
    id: formData.get("id"),
    code: formData.get("code"),
    criterionName: formData.get("criterionName"),
    wsosSectionId: formData.get("wsosSectionId"),
    score3: formData.get("score3") || undefined,
    score2: formData.get("score2") || undefined,
    score1: formData.get("score1") || undefined,
    score0: formData.get("score0") || undefined,
    tags: formData.get("tags") || undefined,
  });

  if (!parsed.success) {
    const error = parsed.error.errors[0]?.message ?? "Invalid input";
    const id = formData.get("id") as string;
    const params = new URLSearchParams({ error });
    return redirect(`/hub/descriptors/my-descriptors/${id}/edit?${params.toString()}`);
  }

  const data = parsed.data;
  const tags = parseCommaSeparated(data.tags);

  // Verify ownership and DRAFT status
  const existing = await prisma.descriptor.findFirst({
    where: {
      id: data.id,
      createdById: user.id,
      batchStatus: DescriptorBatchStatus.DRAFT,
      deletedAt: null,
    },
  });

  if (!existing) {
    const params = new URLSearchParams({ error: "Descriptor not found or cannot be edited" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  try {
    await prisma.$executeRaw`
      UPDATE "Descriptor"
      SET
        code = ${data.code.trim()},
        "criterionName" = ${data.criterionName.trim()},
        score3 = ${data.score3?.trim() || null},
        score2 = ${data.score2?.trim() || null},
        score1 = ${data.score1?.trim() || null},
        score0 = ${data.score0?.trim() || null},
        "wsosSectionId" = ${data.wsosSectionId},
        tags = ${tags}::text[],
        "updatedAt" = NOW()
      WHERE id = ${data.id}
        AND "createdById" = ${user.id}
        AND "batchStatus" = ${DescriptorBatchStatus.DRAFT}::"DescriptorBatchStatus"
    `;
  } catch (error) {
    console.error("Failed to update descriptor", error);
    const params = new URLSearchParams({ error: "Failed to update descriptor" });
    return redirect(`/hub/descriptors/my-descriptors/${data.id}/edit?${params.toString()}`);
  }

  revalidatePath("/hub/descriptors/my-descriptors");
  revalidatePath(`/hub/descriptors/my-descriptors/${data.id}/edit`);
  const params = new URLSearchParams({ updated: "1" });
  return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
}

/**
 * Delete (soft-delete) an SCM's draft descriptor.
 * Only allowed if:
 * - Descriptor is owned by current user
 * - Descriptor is in DRAFT status
 */
export async function deleteSCMDescriptorAction(formData: FormData) {
  const user = await requireUser();

  if (user.role !== "SCM") {
    throw new Error("Only SCMs can delete descriptors through this interface");
  }

  const id = formData.get("id") as string;
  if (!id) {
    const params = new URLSearchParams({ error: "Descriptor ID required" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  // Verify ownership and DRAFT status
  const existing = await prisma.descriptor.findFirst({
    where: {
      id,
      createdById: user.id,
      batchStatus: DescriptorBatchStatus.DRAFT,
      deletedAt: null,
    },
  });

  if (!existing) {
    const params = new URLSearchParams({ error: "Descriptor not found or cannot be deleted" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  try {
    await prisma.descriptor.update({
      where: { id },
      data: {
        deletedAt: new Date(),
        deletedBy: user.id,
      },
    });
  } catch (error) {
    console.error("Failed to delete descriptor", error);
    const params = new URLSearchParams({ error: "Failed to delete descriptor" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  revalidatePath("/hub/descriptors/my-descriptors");
  const params = new URLSearchParams({ deleted: "1" });
  return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
}

/**
 * Submit all DRAFT descriptors as a batch for SA review.
 * Updates all DRAFT -> PENDING_REVIEW with:
 * - Same batchId (groups them)
 * - submittedAt timestamp
 *
 * Phase 9 will add email notification to SA here.
 */
export async function submitBatchAction() {
  const user = await requireUser();

  if (user.role !== "SCM") {
    throw new Error("Only SCMs can submit batches");
  }

  // Check if there are any drafts to submit
  const draftCount = await prisma.descriptor.count({
    where: {
      createdById: user.id,
      batchStatus: DescriptorBatchStatus.DRAFT,
      deletedAt: null,
    },
  });

  if (draftCount === 0) {
    const params = new URLSearchParams({ error: "No draft descriptors to submit" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  const batchId = crypto.randomUUID();
  const now = new Date();

  try {
    await prisma.descriptor.updateMany({
      where: {
        createdById: user.id,
        batchStatus: DescriptorBatchStatus.DRAFT,
        deletedAt: null,
      },
      data: {
        batchStatus: DescriptorBatchStatus.PENDING_REVIEW,
        batchId,
        submittedAt: now,
      },
    });
  } catch (error) {
    console.error("Failed to submit batch", error);
    const params = new URLSearchParams({ error: "Failed to submit batch" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  // TODO: Phase 9 - Send email notification to SA here

  revalidatePath("/hub/descriptors/my-descriptors");
  const params = new URLSearchParams({ submitted: String(draftCount) });
  return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
}
```

KEY REQUIREMENTS IMPLEMENTED:
- DESC-01: SCM can create descriptors with same fields as admin (code, criterionName, performance levels, tags)
- DESC-02: wsosSectionId is REQUIRED (Zod validation enforces this)
- DESC-04: qualityIndicator = NEEDS_REVIEW automatically
- BATCH-01: batchStatus = DRAFT on create, explicit submitBatchAction to change to PENDING_REVIEW
- BATCH-03: submitBatchAction sets batchId and submittedAt for all DRAFT descriptors

SECURITY:
- All actions verify user.role === "SCM"
- Update/delete verify createdById === user.id AND batchStatus === DRAFT
- Users cannot edit/delete once submitted (PENDING_REVIEW)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check that all 4 actions are exported.
  </verify>
  <done>
src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts created with:
- createSCMDescriptorAction (DESC-01, DESC-02, DESC-04, BATCH-01)
- updateSCMDescriptorAction (ownership + DRAFT check)
- deleteSCMDescriptorAction (ownership + DRAFT check)
- submitBatchAction (BATCH-03)
- All actions verify SCM role
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- [ ] Directory exists at src/app/(dashboard)/hub/descriptors/my-descriptors/
- [ ] File exists at src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
- [ ] `npx tsc --noEmit` passes
- [ ] All 4 actions exported (createSCMDescriptorAction, updateSCMDescriptorAction, deleteSCMDescriptorAction, submitBatchAction)
- [ ] createSCMDescriptorAction requires wsosSectionId (DESC-02)
- [ ] createSCMDescriptorAction sets NEEDS_REVIEW quality (DESC-04)
- [ ] createSCMDescriptorAction sets DRAFT status (BATCH-01)
- [ ] submitBatchAction updates DRAFT to PENDING_REVIEW (BATCH-03)
</verification>

<success_criteria>
- SCM can create descriptor with mandatory WSOS section via Server Action
- New descriptors automatically get NEEDS_REVIEW quality and DRAFT batch status
- Update/delete actions verify ownership and DRAFT status
- submitBatchAction changes all DRAFT descriptors to PENDING_REVIEW with same batchId
- All actions properly validate SCM role
</success_criteria>

<output>
After completion, create `.planning/phases/07-scm-descriptor-creation-batch-workflow/07-03-SUMMARY.md`
</output>
