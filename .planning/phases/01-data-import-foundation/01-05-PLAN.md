---
phase: 01-data-import-foundation
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - prisma/migrations/*_add_fts_indexes/migration.sql
autonomous: true

must_haves:
  truths:
    - "GIN indexes exist for full-text search on descriptor content"
    - "Full-text search queries return ranked results"
    - "Search performance is acceptable (<100ms for typical queries)"
  artifacts:
    - path: "prisma/migrations/*_add_fts_indexes/migration.sql"
      provides: "GIN index migration for FTS"
      contains: "CREATE INDEX"
  key_links:
    - from: "prisma/migrations/*_add_fts_indexes/migration.sql"
      to: "Descriptor table"
      via: "GIN index"
      pattern: "to_tsvector"
---

<objective>
Create GIN indexes for full-text search after bulk import is complete.

Purpose: Enable fast full-text search across descriptor content. GIN indexes are created AFTER import because building indexes during bulk insert is 10-100x slower.
Output: Database has GIN indexes for searching descriptor text, search queries are fast.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-import-foundation/01-RESEARCH.md
@.planning/phases/01-data-import-foundation/01-04-SUMMARY.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GIN index migration</name>
  <files>prisma/migrations/*_add_fts_indexes/migration.sql</files>
  <action>
Create a raw SQL migration for GIN indexes. Prisma doesn't support GIN indexes natively, so we use raw SQL:

1. Create the migration directory and SQL file:

```bash
mkdir -p prisma/migrations/20260201000000_add_fts_indexes
```

2. Create the migration SQL at `prisma/migrations/20260201000000_add_fts_indexes/migration.sql`:

```sql
-- GIN indexes for full-text search on Descriptor table
-- Created AFTER bulk import to avoid 10-100x slowdown during insert

-- Primary FTS index: search across criterion name
-- Most common search use case
CREATE INDEX IF NOT EXISTS descriptor_criterion_fts_idx ON "Descriptor"
USING gin(
  to_tsvector('english', coalesce("criterionName", ''))
);

-- Combined FTS index: search across all text content
-- For broader searches
CREATE INDEX IF NOT EXISTS descriptor_all_fts_idx ON "Descriptor"
USING gin(
  to_tsvector('english',
    coalesce("criterionName", '') || ' ' ||
    coalesce("excellent", '') || ' ' ||
    coalesce("good", '') || ' ' ||
    coalesce("pass", '') || ' ' ||
    coalesce("belowPass", '')
  )
);

-- GIN index on tags array for tag-based filtering
-- Enables @> (contains) queries on tags
CREATE INDEX IF NOT EXISTS descriptor_tags_idx ON "Descriptor"
USING gin("tags");
```

3. Apply the migration:

```bash
npx prisma migrate deploy
```

Note: Using `migrate deploy` (not `migrate dev`) because this is a SQL-only migration without schema changes.

If `migrate deploy` doesn't pick up the new migration, use:

```bash
npx prisma migrate resolve --applied 20260201000000_add_fts_indexes
```

And then run the SQL manually:

```bash
npx prisma db execute --file prisma/migrations/20260201000000_add_fts_indexes/migration.sql
```
  </action>
  <verify>
Run in psql or Prisma db execute:
```sql
SELECT indexname FROM pg_indexes WHERE tablename = 'Descriptor' AND indexname LIKE '%fts%';
```
Should return: descriptor_criterion_fts_idx, descriptor_all_fts_idx
  </verify>
  <done>GIN indexes created for full-text search on criterionName and combined content</done>
</task>

<task type="auto">
  <name>Task 2: Verify FTS indexes and search performance</name>
  <files>None (verification only)</files>
  <action>
Test that full-text search works with the GIN indexes:

1. Connect to database and run test queries:

```bash
npx prisma db execute --stdin <<'EOF'
-- Test search for a common term
EXPLAIN ANALYZE
SELECT id, "criterionName", "skillName",
  ts_rank(
    to_tsvector('english', "criterionName"),
    plainto_tsquery('english', 'safety')
  ) as rank
FROM "Descriptor"
WHERE to_tsvector('english', "criterionName") @@ plainto_tsquery('english', 'safety')
ORDER BY rank DESC
LIMIT 10;
EOF
```

2. Verify the query uses the GIN index (look for "Bitmap Index Scan" or "Index Scan" on descriptor_criterion_fts_idx in EXPLAIN output).

3. Check timing is reasonable (<100ms for result set).

4. Test a few different search terms:
   - "welding" (skill-specific)
   - "quality" (common term)
   - "measurement" (technical term)
   - "teamwork" (soft skill)

5. If performance is poor (>500ms), consider:
   - Running VACUUM ANALYZE on the table
   - Checking index size vs table size
  </action>
  <verify>
- GIN indexes appear in pg_indexes
- EXPLAIN ANALYZE shows index usage
- Search queries complete in <100ms
- Results are ranked by relevance
  </verify>
  <done>FTS indexes verified working, search performance acceptable, queries return ranked results</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and phase completion</name>
  <files>None (verification only)</files>
  <action>
Verify all Phase 1 success criteria are met:

1. **All 58 files parsed:** Check import-report.json shows all files processed
   ```bash
   cat import-report.json | grep -c "fileName"
   ```

2. **Descriptors with performance levels:** Query database for completeness
   ```sql
   SELECT
     COUNT(*) as total,
     COUNT("excellent") as with_excellent,
     COUNT("good") as with_good,
     COUNT("pass") as with_pass,
     COUNT("belowPass") as with_below
   FROM "Descriptor"
   WHERE source = 'WSC2024';
   ```

3. **Text normalized:** Check for smart quote artifacts
   ```sql
   SELECT COUNT(*)
   FROM "Descriptor"
   WHERE "criterionName" LIKE '%'%' OR "criterionName" LIKE '%"%';
   ```
   Should return 0 (no smart quotes).

4. **Source metadata captured:**
   ```sql
   SELECT "skillName", COUNT(*) as count
   FROM "Descriptor"
   WHERE source = 'WSC2024'
   GROUP BY "skillName"
   ORDER BY count DESC
   LIMIT 10;
   ```
   Should show diverse skill names.

5. **Schema versioning:** All records should have version=1
   ```sql
   SELECT version, COUNT(*)
   FROM "Descriptor"
   GROUP BY version;
   ```

Print summary of verification results.
  </action>
  <verify>All 5 success criteria checks pass</verify>
  <done>Phase 1 complete - all WSC2024 descriptors imported with metadata, normalized, and searchable</done>
</task>

</tasks>

<verification>
- GIN indexes exist: `SELECT indexname FROM pg_indexes WHERE tablename = 'Descriptor'`
- FTS queries use indexes (check EXPLAIN ANALYZE)
- Search performance <100ms for typical queries
- All phase success criteria verified
</verification>

<success_criteria>
1. GIN indexes created: descriptor_criterion_fts_idx, descriptor_all_fts_idx, descriptor_tags_idx
2. Full-text search queries return ranked results
3. Search performance <100ms for typical queries
4. All 5 phase success criteria verified:
   - All 58 files parsed
   - Performance levels stored (grouped)
   - Text normalized (no smart quotes)
   - Source metadata captured
   - Version field populated
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-import-foundation/01-05-SUMMARY.md`

Include in summary:
- GIN indexes created
- Search performance benchmarks
- Final verification results for all phase criteria
</output>
