---
phase: 01-data-import-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - package.json
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "Descriptor model exists in Prisma schema with all required fields"
    - "ExcelJS 4.4+ is installed and available for import"
    - "Database migration applies without error"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Descriptor model with performance levels, metadata, version field"
      contains: "model Descriptor"
    - path: "prisma/migrations/*_add_descriptors/migration.sql"
      provides: "SQL migration for Descriptor table"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Prisma client"
      via: "prisma generate"
      pattern: "model Descriptor"
---

<objective>
Establish database schema for descriptor library and install ExcelJS dependency.

Purpose: Create the foundation for storing WSC2024 descriptors with complete performance levels, source metadata, and schema versioning.
Output: Prisma Descriptor model, applied migration, ExcelJS installed.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-import-foundation/01-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Descriptor model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the Descriptor model to the existing Prisma schema with the following structure:

```prisma
model Descriptor {
  id          String   @id @default(cuid())
  code        String   // Criterion code from marking scheme (e.g., "A1", "B2.1")
  criterionName String // Name of the criterion/aspect

  // Performance level descriptions (grouped together, not separate records)
  excellent   String?  @db.Text
  good        String?  @db.Text
  pass        String?  @db.Text
  belowPass   String?  @db.Text

  // Source metadata
  source      String   // "WSC2024" for imported, "Manual" for admin-added
  skillName   String   // Name of the skill (e.g., "Welding", "Bricklaying")
  sector      String?  // Sector category if available

  // Categories and tags (for future filtering)
  category    String?  // Criterion type/category
  tags        String[] @default([]) // JSONB array for flexible tagging

  // Schema versioning for future migrations
  version     Int      @default(1)

  // Audit timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Composite unique constraint: code unique within a skill
  @@unique([skillName, code])

  // B-tree indexes for common filters (GIN indexes added after import)
  @@index([source])
  @@index([skillName])
  @@index([sector])
  @@index([category])
  @@index([version])
}
```

Place the model after the existing ResourceLink model. Use `String[]` with `@default([])` for tags (Prisma supports PostgreSQL arrays natively). Do NOT add GIN indexes yet - those are created after bulk import completes.
  </action>
  <verify>Run `npx prisma validate` to ensure schema is valid</verify>
  <done>Descriptor model exists in schema.prisma with all fields for performance levels, metadata, and versioning</done>
</task>

<task type="auto">
  <name>Task 2: Install ExcelJS and create migration</name>
  <files>package.json, pnpm-lock.yaml, prisma/migrations/*</files>
  <action>
1. Install ExcelJS 4.4+ (secure Excel parser, NOT SheetJS which has CVE-2023-30533):
   ```bash
   pnpm add exceljs
   ```

2. Generate and apply the Prisma migration:
   ```bash
   npx prisma migrate dev --name add_descriptors
   ```

3. Verify the migration SQL was created and the Descriptor table exists.

Do NOT install SheetJS (xlsx package) - it has known security vulnerabilities and is no longer published to npm.
  </action>
  <verify>
- Run `pnpm list exceljs` to confirm ExcelJS is installed (version 4.4.0+)
- Run `npx prisma db pull --force` should not show any drift
- Check migration file exists in prisma/migrations/
  </verify>
  <done>ExcelJS 4.4+ installed, Descriptor table created in database via Prisma migration</done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes with no errors
- `pnpm list exceljs` shows version 4.4.0 or higher
- Migration file exists at `prisma/migrations/*_add_descriptors/migration.sql`
- Prisma Studio shows Descriptor table with correct columns
</verification>

<success_criteria>
1. Descriptor model in schema.prisma with: id, code, criterionName, excellent/good/pass/belowPass, source, skillName, sector, category, tags, version, timestamps
2. Composite unique constraint on [skillName, code]
3. B-tree indexes on source, skillName, sector, category, version
4. ExcelJS 4.4+ in package.json dependencies
5. Migration applied, Descriptor table exists in database
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-import-foundation/01-01-SUMMARY.md`
</output>
