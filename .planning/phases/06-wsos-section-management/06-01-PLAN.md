---
phase: 06-wsos-section-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_wsos_sections/migration.sql
  - src/lib/wsos-sections.ts
autonomous: true

must_haves:
  truths:
    - "WSOSSection model exists in database with name field"
    - "Trigram similarity queries execute using GIN index (not sequential scan)"
    - "findSimilarWSOSSections function returns sections with similarity > 0.3"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "WSOSSection model definition"
      contains: "model WSOSSection"
    - path: "src/lib/wsos-sections.ts"
      provides: "Query utilities and duplicate detection"
      exports: ["getAllWSOSSections", "findSimilarWSOSSections"]
  key_links:
    - from: "src/lib/wsos-sections.ts"
      to: "prisma.wSOSSection"
      via: "Prisma client queries"
      pattern: "prisma\\.wSOSSection\\.(findMany|create)"
    - from: "src/lib/wsos-sections.ts"
      to: "pg_trgm similarity()"
      via: "raw SQL query"
      pattern: "similarity.*name"
---

<objective>
Create WSOSSection database model with trigram index for duplicate detection and query utilities.

Purpose: Establish the data layer for WSOS sections that SCMs will browse and create. The trigram index enables similarity-based duplicate warnings before creating new sections.
Output: WSOSSection table with GIN trigram index, query functions for listing and duplicate detection.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-wsos-section-management/06-RESEARCH.md

# Existing patterns to follow
@prisma/schema.prisma
@src/lib/duplicate-detection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WSOSSection model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add WSOSSection model to schema.prisma with these fields:
- id: String @id @default(cuid())
- name: String @unique (section name, e.g., "Work Organisation and Management")
- description: String? @db.Text (optional longer description)
- createdAt: DateTime @default(now())
- createdBy: String (User ID who created it)
- updatedAt: DateTime @updatedAt

Add relation to User model:
- creator: User @relation("WSOSSectionCreator", fields: [createdBy], references: [id])

Add to User model:
- createdWSOSSections: WSOSSection[] @relation("WSOSSectionCreator")

Add index:
- @@index([name]) for B-tree exact lookups

Note: The GIN trigram index will be added manually to the migration SQL (Prisma cannot generate it).
  </action>
  <verify>Run `npx prisma validate` - should pass without errors</verify>
  <done>WSOSSection model defined in schema.prisma with User relation and B-tree index</done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and add GIN trigram index</name>
  <files>prisma/migrations/[new]/migration.sql</files>
  <action>
1. Run `npx prisma migrate dev --name wsos_sections` to generate migration
2. Open the generated migration.sql file
3. MANUALLY add this line at the end of the migration (after Prisma-generated SQL):
   ```sql
   -- GIN trigram index for similarity queries (manual addition - Prisma cannot generate this)
   CREATE INDEX wsos_section_name_trgm ON "WSOSSection" USING GIN (name gin_trgm_ops);
   ```
4. Run `npx prisma migrate dev` again to apply the modified migration (it may already be applied, that's fine)
5. Run `npx prisma generate` to update the Prisma client

IMPORTANT: The pg_trgm extension is already installed (used by descriptor duplicate detection). Do NOT add CREATE EXTENSION - it will fail if extension already exists.
  </action>
  <verify>
Run these commands to verify:
1. `npx prisma db pull --force` should not show any drift
2. Query to verify index exists:
   ```bash
   npx prisma db execute --stdin <<< "SELECT indexname FROM pg_indexes WHERE tablename = 'WSOSSection' AND indexname LIKE '%trgm%';"
   ```
   Should return: wsos_section_name_trgm
  </verify>
  <done>Migration applied with WSOSSection table and GIN trigram index on name column</done>
</task>

<task type="auto">
  <name>Task 3: Create query utilities and duplicate detection function</name>
  <files>src/lib/wsos-sections.ts</files>
  <action>
Create src/lib/wsos-sections.ts with:

1. SimilarSection interface:
   - id: string
   - name: string
   - similarity: number

2. getAllWSOSSections() function:
   - Returns all sections ordered by name ascending
   - Includes creator info (id, name, email)
   - Export the return type as WSOSSectionWithCreator

3. findSimilarWSOSSections(name, threshold?, excludeId?, limit?) function:
   - Parameters: name (string), threshold (default 0.3), excludeId (optional string), limit (default 5)
   - Return early with [] if name is empty or less than 3 characters
   - Use Prisma.sql template literal for raw query (see src/lib/duplicate-detection.ts pattern)
   - Query: SELECT id, name, similarity(name, $1) as similarity FROM "WSOSSection" WHERE similarity(name, $1) > $2 [AND id != $3] ORDER BY similarity DESC LIMIT $4
   - Use 0.3 threshold (not 0.4 like descriptors) because section names are shorter

4. getWSOSSectionById(id) function:
   - Simple findUnique query
   - Return null if not found

Follow the exact pattern from src/lib/duplicate-detection.ts for the similarity query structure.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/lib/wsos-sections.ts
```
  </verify>
  <done>Query utilities exported: getAllWSOSSections, findSimilarWSOSSections, getWSOSSectionById with proper types</done>
</task>

</tasks>

<verification>
1. Database schema is valid: `npx prisma validate` passes
2. Migration applied: WSOSSection table exists in database
3. Trigram index exists: Query pg_indexes confirms wsos_section_name_trgm
4. TypeScript compiles: `npx tsc --noEmit` passes for new file
5. Prisma client updated: `import { WSOSSection } from "@prisma/client"` resolves
</verification>

<success_criteria>
- WSOSSection model exists in Prisma schema with @unique name constraint
- GIN trigram index (wsos_section_name_trgm) exists in database
- getAllWSOSSections returns sections with creator info
- findSimilarWSOSSections uses pg_trgm similarity() with 0.3 threshold
- All TypeScript types generated and available
</success_criteria>

<output>
After completion, create `.planning/phases/06-wsos-section-management/06-01-SUMMARY.md`
</output>
