---
phase: 06-wsos-section-management
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(dashboard)/settings/wsos-sections/page.tsx
  - src/app/(dashboard)/settings/wsos-sections/actions.ts
  - src/components/wsos/duplicate-warning.tsx
autonomous: true

must_haves:
  truths:
    - "SCM can view list of all existing WSOS sections"
    - "SCM can create new WSOS section by entering a name"
    - "System warns SCM when creating section similar to existing ones"
    - "New WSOS sections are immediately available (no approval delay)"
  artifacts:
    - path: "src/app/(dashboard)/settings/wsos-sections/page.tsx"
      provides: "WSOS section management page"
      min_lines: 100
    - path: "src/app/(dashboard)/settings/wsos-sections/actions.ts"
      provides: "Server Actions for CRUD operations"
      exports: ["createWSOSSectionAction", "updateWSOSSectionAction", "deleteWSOSSectionAction"]
    - path: "src/components/wsos/duplicate-warning.tsx"
      provides: "Duplicate warning UI component"
      exports: ["DuplicateWarning"]
  key_links:
    - from: "src/app/(dashboard)/settings/wsos-sections/page.tsx"
      to: "src/lib/wsos-sections.ts"
      via: "getAllWSOSSections import"
      pattern: "import.*getAllWSOSSections"
    - from: "src/app/(dashboard)/settings/wsos-sections/actions.ts"
      to: "prisma.wSOSSection"
      via: "Prisma create/update/delete"
      pattern: "prisma\\.wSOSSection\\.(create|update|delete)"
    - from: "src/components/wsos/duplicate-warning.tsx"
      to: "SimilarSection type"
      via: "Type import"
      pattern: "SimilarSection"
---

<objective>
Build the complete WSOS section management UI with Server Actions and duplicate warning.

Purpose: Enable SCMs to browse existing sections and create new ones with real-time duplicate detection warnings. This is the user-facing part of WSOS section management.
Output: Fully functional settings page at /settings/wsos-sections with create/edit/delete and similarity warnings.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-wsos-section-management/06-RESEARCH.md
@.planning/phases/06-wsos-section-management/06-01-SUMMARY.md

# Existing patterns to follow exactly
@src/app/(dashboard)/settings/resources/page.tsx
@src/app/(dashboard)/settings/resources/actions.ts
@src/lib/wsos-sections.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for WSOS section CRUD</name>
  <files>src/app/(dashboard)/settings/wsos-sections/actions.ts</files>
  <action>
Create src/app/(dashboard)/settings/wsos-sections/actions.ts following the ResourceLink actions pattern:

1. Add "use server" directive at top

2. createWSOSSectionSchema with Zod:
   - name: z.string().min(3, "Section name must be at least 3 characters")
   - description: z.string().optional()

3. createWSOSSectionAction(formData: FormData):
   - Call requireUser() (not requireAdminUser - SCMs can create)
   - Check role: if (user.role !== "SCM" && !user.isAdmin) throw error
   - Parse formData with createWSOSSectionSchema
   - On validation error, redirect with ?error=message
   - Create section with prisma.wSOSSection.create, set createdBy to user.id
   - IMPORTANT: Trim name and description before saving
   - Handle P2002 unique constraint error: "A section with this name already exists"
   - revalidatePath("/settings/wsos-sections")
   - Redirect with ?created=1

4. updateWSOSSectionSchema - same as create but with id field

5. updateWSOSSectionAction(formData: FormData):
   - Same auth checks as create
   - Update with prisma.wSOSSection.update
   - Redirect with ?updated=1

6. deleteWSOSSectionAction(formData: FormData):
   - Same auth checks
   - Delete with prisma.wSOSSection.delete
   - Redirect with ?deleted=1

7. checkSimilarSectionsAction(name: string): Promise<SimilarSection[]>
   - This is a callable Server Action for the duplicate warning component
   - Call findSimilarWSOSSections(name, 0.3) from src/lib/wsos-sections.ts
   - Return the array (no redirect, this is for client-side checking)

All redirects go to /settings/wsos-sections with appropriate query params.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/app/(dashboard)/settings/wsos-sections/actions.ts`</verify>
  <done>Server Actions exported: createWSOSSectionAction, updateWSOSSectionAction, deleteWSOSSectionAction, checkSimilarSectionsAction</done>
</task>

<task type="auto">
  <name>Task 2: Create duplicate warning component</name>
  <files>src/components/wsos/duplicate-warning.tsx</files>
  <action>
Create src/components/wsos/duplicate-warning.tsx:

1. "use client" directive (uses state for visibility)

2. Props interface:
   - similar: SimilarSection[] (import from src/lib/wsos-sections.ts)
   - className?: string

3. DuplicateWarning component:
   - If similar.length === 0, return null
   - Render a warning card with amber/yellow styling (border-amber-500 bg-amber-50 dark:bg-amber-950)
   - Header: "Similar sections found" with AlertTriangle icon from lucide-react
   - List each similar section:
     - Name with similarity percentage: "{name} ({Math.round(similarity * 100)}% similar)"
   - Footer text: "Consider using an existing section instead of creating a duplicate."

Keep it simple - this is a presentational component. The parent will pass the similar sections array.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/wsos/duplicate-warning.tsx`</verify>
  <done>DuplicateWarning component exported with proper styling and similarity display</done>
</task>

<task type="auto">
  <name>Task 3: Create WSOS sections management page</name>
  <files>src/app/(dashboard)/settings/wsos-sections/page.tsx</files>
  <action>
Create src/app/(dashboard)/settings/wsos-sections/page.tsx following ResourceLink page pattern:

1. Imports:
   - Link, redirect from next
   - format from date-fns
   - ArrowLeft, Pencil, Plus, Trash2 from lucide-react
   - UI components: Badge, Button, Card, CardContent, CardDescription, CardHeader, CardTitle, Input, Label, Textarea
   - requireUser from @/lib/auth
   - getAllWSOSSections from @/lib/wsos-sections
   - Server Actions from ./actions
   - WSOSSectionForm client component (we'll create inline)

2. Page component (async server component):
   - searchParams: { error?, created?, updated?, deleted?, edit? }
   - Call requireUser()
   - Role check: if (user.role !== "SCM" && !user.isAdmin) redirect("/dashboard")
   - Fetch sections with getAllWSOSSections()
   - Find editingSection if ?edit=id present

3. Layout:
   - Back to Settings link (like resources page)
   - Header: "WSOS Sections" with description "Manage WSOS sections for organizing descriptors."
   - Success/Error message cards (same pattern as resources)

4. Create/Edit Form Card:
   - Title changes based on editing mode
   - Use a CLIENT COMPONENT for the form to enable live duplicate checking
   - Fields: name (Input), description (Textarea optional)
   - Hidden input for id when editing
   - Submit button: "Create Section" or "Update Section"
   - Cancel button when editing (links to /settings/wsos-sections)

5. WSOSSectionForm (client component - define at top of file or separate):
   - "use client"
   - Props: editingSection (optional), action (Server Action)
   - useState for name input value
   - useState for similar sections array
   - useDebouncedCallback (from use-debounce) to check similar on name change (500ms delay)
   - Call checkSimilarSectionsAction when name changes (if length >= 3)
   - Render DuplicateWarning component below name input
   - Native form with action prop pointing to Server Action

6. Existing Sections Card:
   - Show count in description: "{N} section(s)"
   - Empty state if no sections
   - For each section, render:
     - Name (bold)
     - Description (if exists, truncated)
     - Creator name and created date
     - Edit button: Link to ?edit={id}
     - Delete button: form with deleteWSOSSectionAction

Follow the exact Card/layout structure from settings/resources/page.tsx.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev` (briefly check for build errors)
3. Navigate to http://localhost:3000/settings/wsos-sections as SCM or Admin user
  </verify>
  <done>
- Page renders at /settings/wsos-sections
- SCM/Admin can access, others redirected
- Create form with live duplicate warning
- Edit via ?edit=id query param
- Delete with confirmation form
- Success/error messages display correctly
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Role check works: Non-SCM users redirected to /dashboard
3. Create flow: Fill name, see duplicate warning if similar exists, submit creates section
4. Edit flow: Click edit, form populates, submit updates section
5. Delete flow: Click delete, section removed from list
6. Immediate availability: New section appears in list without refresh (revalidatePath works)
</verification>

<success_criteria>
- SCM can view list of all existing WSOS sections with names and creators
- SCM can create new WSOS section by entering name (optional description)
- Duplicate warning appears when typing name similar to existing section (>30% similarity)
- New sections immediately appear in list after creation
- Edit and delete functions work correctly
- Non-SCM/Admin users cannot access the page
</success_criteria>

<output>
After completion, create `.planning/phases/06-wsos-section-management/06-02-SUMMARY.md`
</output>
