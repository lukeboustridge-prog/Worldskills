---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_make_meeting_skill_optional/migration.sql
autonomous: true

must_haves:
  truths:
    - "Meeting can be created with skillId set to null"
    - "MeetingAttendee junction table exists in database"
    - "All existing skill meetings have their skillId preserved after migration"
    - "Database constraints allow NULL skillId without errors"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Optional skillId on Meeting, MeetingAttendee model"
      contains: "skillId String?"
    - path: "prisma/migrations/*_make_meeting_skill_optional/migration.sql"
      provides: "Migration script for schema changes"
      contains: "ALTER COLUMN"
  key_links:
    - from: "Meeting.skillId"
      to: "Skill.id"
      via: "optional foreign key relation"
      pattern: "skillId\\s+String\\?"
    - from: "MeetingAttendee"
      to: "Meeting"
      via: "onDelete: Cascade"
      pattern: "onDelete:\\s*Cascade"
---

<objective>
Update Prisma schema to make Meeting.skillId optional and add MeetingAttendee junction table for per-meeting attendee tracking.

Purpose: Enable management meetings (not tied to any skill) and support selective attendee lists for Secretariat members per meeting.
Output: Updated schema.prisma with migration applied, Prisma client regenerated with new types.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation-&-type-system/01-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema for optional skillId and MeetingAttendee</name>
  <files>prisma/schema.prisma</files>
  <action>
Modify the Meeting model to make skillId optional:

1. Change `skillId String` to `skillId String?`
2. Change `skill Skill @relation(...)` to `skill Skill? @relation(...)`
3. Verify `@@index([skillId])` exists (already present - keep it)

Add MeetingAttendee junction table model after the Meeting model:

```prisma
model MeetingAttendee {
  meetingId String
  userId    String
  addedAt   DateTime @default(now())
  addedBy   String?

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([meetingId, userId])
  @@index([meetingId])
  @@index([userId])
}
```

Add the attendees relation to Meeting model:
- Add `attendees MeetingAttendee[]` to the Meeting model

Add the meetingAttendees relation to User model:
- Add `meetingAttendees MeetingAttendee[]` to the User model

IMPORTANT: Do NOT add any `onDelete` action to the Meeting.skill relation - keep the default `Restrict` behavior. This ensures skills cannot be deleted while meetings reference them.
  </action>
  <verify>Run `npx prisma validate` - should report no errors</verify>
  <done>Schema validates successfully with optional skillId and MeetingAttendee model</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply migration</name>
  <files>prisma/migrations/[timestamp]_make_meeting_skill_optional/migration.sql</files>
  <action>
Generate migration with --create-only first to review SQL:

```bash
npx prisma migrate dev --create-only --name make_meeting_skill_optional
```

Review the generated migration SQL in `prisma/migrations/[timestamp]_make_meeting_skill_optional/migration.sql`:
1. Should contain `ALTER TABLE "Meeting" ALTER COLUMN "skillId" DROP NOT NULL` or equivalent
2. Should contain `CREATE TABLE "MeetingAttendee"` with composite primary key
3. Should NOT contain `DROP TABLE` or `DROP COLUMN` for any existing tables

If migration looks correct, apply it:

```bash
npx prisma migrate dev
```

Then regenerate the Prisma client:

```bash
npx prisma generate
```

CAUTION: If the migration contains any destructive operations (DROP TABLE, DROP COLUMN), do NOT apply it. Instead, manually edit the migration.sql to preserve data.
  </action>
  <verify>
1. Run `npx prisma migrate status` - should show migration applied
2. Run `npx prisma db pull --print` and verify skillId shows as optional
3. TypeScript compilation: `npx tsc --noEmit` - expect errors (addressed in Plan 02)
  </verify>
  <done>Migration applied successfully, MeetingAttendee table created, skillId allows NULL values</done>
</task>

<task type="auto">
  <name>Task 3: Verify data preservation and new table functionality</name>
  <files>None (verification only)</files>
  <action>
Create a quick verification script or use Prisma Studio to confirm:

1. Check existing meetings still have their skillId values:
   ```bash
   npx prisma studio
   ```
   Open Meeting table - all existing records should have non-null skillId values

2. Verify MeetingAttendee table exists and is empty (no records yet expected)

3. Test that a meeting can be created with null skillId using Prisma Studio or a quick script:
   - Create a test record in Meeting with skillId: null
   - Confirm it saves without constraint violations
   - Delete the test record

The verification ensures DB-03 (migration preserves existing skill meetings) and DB-01 (NULL skillId allowed) are satisfied at the database level.
  </action>
  <verify>
1. `SELECT COUNT(*) FROM "Meeting" WHERE "skillId" IS NOT NULL` equals total meeting count (existing data preserved)
2. `SELECT COUNT(*) FROM "MeetingAttendee"` returns 0 (empty table ready for use)
3. Can INSERT a Meeting with NULL skillId without error
  </verify>
  <done>All existing meetings preserved, new functionality operational at database level</done>
</task>

</tasks>

<verification>
Phase-level checks after all tasks complete:

1. Schema validation: `npx prisma validate` passes
2. Migration status: `npx prisma migrate status` shows all migrations applied
3. Database structure: MeetingAttendee table exists with correct indexes
4. Data integrity: All pre-existing meetings retain their skillId values
5. NULL support: Meeting.skillId accepts NULL values
</verification>

<success_criteria>
- Meeting.skillId is optional in Prisma schema (`String?`)
- Meeting.skill relation is optional (`Skill?`)
- MeetingAttendee junction table exists with composite primary key
- MeetingAttendee has cascade deletes on both foreign keys
- All existing meeting records preserved with original skillId values
- Prisma Client regenerated with updated types
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation-&-type-system/01-01-SUMMARY.md`
</output>
