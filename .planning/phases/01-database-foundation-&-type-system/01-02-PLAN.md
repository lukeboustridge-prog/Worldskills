---
phase: 01-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(dashboard)/skills/[skillId]/meeting-actions.ts
  - src/app/(dashboard)/hub/meetings/page.tsx
  - src/lib/email/meeting-invitation.ts
  - src/app/api/meetings/[meetingId]/documents/upload/route.ts
  - src/app/api/meetings/[meetingId]/documents/[docId]/download/route.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript compilation passes with no errors related to Meeting.skill access"
    - "Existing skill meetings display correctly in hub meetings page"
    - "Meeting actions handle both skill and management meeting scenarios"
    - "Email invitations work for skill meetings with optional skill reference"
  artifacts:
    - path: "src/app/(dashboard)/skills/[skillId]/meeting-actions.ts"
      provides: "Type-safe meeting actions handling optional skill"
      contains: "meeting.skill?.name"
    - path: "src/app/(dashboard)/hub/meetings/page.tsx"
      provides: "Hub page with null-safe skill access"
      contains: "meeting.skill?.name"
  key_links:
    - from: "meeting-actions.ts"
      to: "prisma.meeting"
      via: "type-safe queries"
      pattern: "meeting\\.skill\\?"
    - from: "hub/meetings/page.tsx"
      to: "meeting.skill"
      via: "optional chaining"
      pattern: "\\.skill\\?"
---

<objective>
Update TypeScript code throughout codebase to handle optional Meeting.skill relation using null-safe access patterns.

Purpose: Ensure type safety and prevent runtime errors when Meeting.skill is null (management meetings).
Output: All TypeScript files compile without errors, existing skill meeting functionality unchanged.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation-&-type-system/01-RESEARCH.md
@.planning/phases/01-database-foundation-&-type-system/01-01-SUMMARY.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update hub meetings page for null-safe skill access</name>
  <files>src/app/(dashboard)/hub/meetings/page.tsx</files>
  <action>
Update all references to `meeting.skill` to use optional chaining:

1. Line ~88: `nextMeeting.skill.name` -> `nextMeeting.skill?.name ?? 'Skill Advisor Meeting'`
2. Line ~148: `meeting.skill.name` -> `meeting.skill?.name ?? 'Skill Advisor Meeting'`
3. Line ~222: `meeting.skill.name` -> `meeting.skill?.name ?? 'Skill Advisor Meeting'`

The fallback text 'Skill Advisor Meeting' is the label for management meetings per PROJECT.md requirements.

Also update the TypeScript include to handle the optional relation:
```typescript
include: { skill: { select: { name: true } } }
```
Prisma now returns `skill: { name: string } | null` - ensure code handles this.

IMPORTANT: Keep all existing functionality intact for skill meetings. Only add null-safety.
  </action>
  <verify>
1. `npx tsc --noEmit` passes for this file
2. Open hub meetings page in browser - existing skill meetings still show skill name
  </verify>
  <done>Hub meetings page compiles and displays both skill and future management meetings correctly</done>
</task>

<task type="auto">
  <name>Task 2: Update meeting-actions.ts for optional skill handling</name>
  <files>src/app/(dashboard)/skills/[skillId]/meeting-actions.ts</files>
  <action>
This file currently requires skillId for all operations. Review each function:

1. `scheduleMeetingAction`: Currently validates `skillId: z.string().min(1)` - this is correct for SKILL meetings scheduled from skill pages. No change needed yet (management meetings will use separate actions in Phase 2).

2. `updateMeetingMinutesAction`: The check `meeting.skillId !== skill.id` at line ~324 needs to handle case where meeting.skillId could be null:
   - Change to: `meeting.skillId !== skill.id` (remains valid - null !== skillId is always true, which correctly rejects)

3. `deleteMeetingAction`: Same pattern at line ~378, already safe.

4. Add/Delete document/link actions: Same pattern, all safe.

5. For the `canScheduleMeeting` function and related logic, ensure the skill relation is properly typed if accessed.

Most importantly: Update any location where meeting is fetched and skill is accessed:
- If code accesses `meeting.skill.xxx` anywhere, add optional chaining
- Currently skill is accessed via `ensureSkill()` which returns skill directly, not from meeting

Review email sending section (~line 257-286):
- `skill.sa?.email` and `skill.scm?.email` already use optional chaining
- `skill.name` is used directly which is safe since skill is from ensureSkill()

No changes expected for this file since skill is retrieved separately via ensureSkill(), not from meeting.skill relation.
  </action>
  <verify>
1. `npx tsc --noEmit` passes for this file
2. Existing meeting scheduling, editing, deleting still works (manual test if needed)
  </verify>
  <done>Meeting actions remain type-safe and functional</done>
</task>

<task type="auto">
  <name>Task 3: Update email and API routes for type safety</name>
  <files>
src/lib/email/meeting-invitation.ts
src/app/api/meetings/[meetingId]/documents/upload/route.ts
src/app/api/meetings/[meetingId]/documents/[docId]/download/route.ts
  </files>
  <action>
Review and update each file for optional skill handling:

**src/lib/email/meeting-invitation.ts:**
- Check if `skillName` parameter is required or optional
- If the function receives skillName as a parameter, ensure callers pass a fallback value
- Example: caller should pass `meeting.skill?.name ?? 'Skill Advisor Meeting'`
- This file likely just uses what it receives - verify no direct Meeting type access

**src/app/api/meetings/[meetingId]/documents/upload/route.ts:**
- Review how meeting is fetched and if skill relation is used
- Add optional chaining if accessing meeting.skill.xxx

**src/app/api/meetings/[meetingId]/documents/[docId]/download/route.ts:**
- Same review pattern
- These likely access meeting.skillId for authorization, which is now optional
- Update authorization checks to handle null skillId (management meetings)

For API routes that validate skillId for access:
- Management meetings (skillId: null) need different authorization rules (handled in Phase 2)
- For now, ensure the code doesn't crash if skillId is null
- If route returns 403/404 for null skillId, that's acceptable for this phase

Example null-safe pattern for authorization:
```typescript
// Before (would crash if skillId null):
const skill = await prisma.skill.findUnique({ where: { id: meeting.skillId } });

// After (safe):
const skill = meeting.skillId
  ? await prisma.skill.findUnique({ where: { id: meeting.skillId } })
  : null;

if (!skill) {
  // For now, reject management meeting document access (Phase 2 adds proper auth)
  return new Response("Not authorized", { status: 403 });
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors
2. Existing document upload/download for skill meetings still works
  </verify>
  <done>All email and API route code is type-safe with optional Meeting.skill</done>
</task>

</tasks>

<verification>
Phase-level checks after all tasks complete:

1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Lint check: `npm run lint` passes
3. Existing functionality: Skill meetings display correctly in hub
4. Database: All meeting records accessible via Prisma queries
</verification>

<success_criteria>
- `npx tsc --noEmit` exits with code 0
- No TypeScript errors related to Meeting.skill or Meeting.skillId access
- Hub meetings page renders existing skill meetings with skill names
- Meeting actions continue to work for skill meetings
- Document upload/download routes handle optional skill gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation-&-type-system/01-02-SUMMARY.md`
</output>
