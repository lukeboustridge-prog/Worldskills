---
phase: 09-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
  - src/app/(dashboard)/hub/descriptors/pending-review/actions.ts
autonomous: true

must_haves:
  truths:
    - "SA receives email when SCM submits batch for review (NOTIF-01)"
    - "SCM receives email when SA approves descriptor, indicating if modified (NOTIF-02/03)"
    - "SCM receives email when SA returns descriptor with comment (NOTIF-04)"
    - "SA receives email when SCM resubmits revised descriptors (NOTIF-05)"
    - "Email failures do not break the primary workflow action"
  artifacts:
    - path: "src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts"
      provides: "Email integration for submitBatchAction"
      contains: "sendBatchSubmittedNotification"
    - path: "src/app/(dashboard)/hub/descriptors/pending-review/actions.ts"
      provides: "Email integration for approveDescriptorAction and returnDescriptorAction"
      contains: "sendDescriptorApprovedNotification"
  key_links:
    - from: "src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts"
      to: "src/lib/email/descriptor-notifications.ts"
      via: "import and call in try/catch"
      pattern: "import.*sendBatchSubmittedNotification"
    - from: "src/app/(dashboard)/hub/descriptors/pending-review/actions.ts"
      to: "src/lib/email/descriptor-notifications.ts"
      via: "import and call in try/catch"
      pattern: "import.*sendDescriptor(Approved|Returned)Notification"
---

<objective>
Integrate email notifications into existing Server Actions.

Purpose: Wire the notification functions from Plan 01 into the approval workflow Server Actions at the marked TODO locations.
Output: Modified Server Actions that send emails on batch submit, approve, return, and resubmit events.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\LukeBoustridge\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-email-notifications/09-RESEARCH.md

# Files to modify
@src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
@src/app/(dashboard)/hub/descriptors/pending-review/actions.ts

# Notification functions from Plan 01
@src/lib/email/descriptor-notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email notifications to submitBatchAction (NOTIF-01 and NOTIF-05)</name>
  <files>src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts</files>
  <action>
Modify `submitBatchAction` in `src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts`:

1. Add import at top:
```typescript
import {
  sendBatchSubmittedNotification,
  sendDescriptorsResubmittedNotification,
} from "@/lib/email/descriptor-notifications";
```

2. Before the batch update, check if any drafts were previously RETURNED (for NOTIF-05 detection):
```typescript
// Check if this is a resubmission (any descriptors were previously RETURNED)
const hasReturnedDescriptors = await prisma.descriptor.count({
  where: {
    createdById: user.id,
    batchStatus: DescriptorBatchStatus.DRAFT,
    deletedAt: null,
    // A descriptor that was returned will have a non-null reviewComment even after being edited
    // OR check if reviewedAt is not null (was previously reviewed)
    reviewedAt: { not: null },
  },
}) > 0;
```

Note: Actually, since updateReturnedDescriptorAction clears reviewComment, reviewerId, and reviewedAt, we cannot detect resubmission this way. Instead, check for descriptors that have a non-null batchId (were previously submitted):
```typescript
const hasResubmittedDescriptors = await prisma.descriptor.count({
  where: {
    createdById: user.id,
    batchStatus: DescriptorBatchStatus.DRAFT,
    deletedAt: null,
    batchId: { not: null }, // Was previously part of a batch submission
  },
}) > 0;
```

3. Replace the `// TODO: Phase 9 - Send email notification to SA here` comment (around line 307) with:
```typescript
// Send email notification to SA (non-blocking)
try {
  // Find the skill where this user is SCM to get the SA
  const skill = await prisma.skill.findFirst({
    where: { scmId: user.id },
    include: { sa: { select: { email: true, name: true } } },
  });

  if (skill?.sa?.email) {
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || "https://skill-tracker.worldskills2026.com";

    if (hasResubmittedDescriptors) {
      // NOTIF-05: Resubmission notification
      await sendDescriptorsResubmittedNotification({
        to: skill.sa.email,
        scmName: user.name ?? "Your SCM",
        descriptorCount: draftCount,
      });
    } else {
      // NOTIF-01: New submission notification
      await sendBatchSubmittedNotification({
        to: skill.sa.email,
        scmName: user.name ?? "Your SCM",
        descriptorCount: draftCount,
      });
    }
  }
} catch (error) {
  console.error("Failed to send batch submission notification", {
    scmId: user.id,
    draftCount,
    error,
  });
}
```

Important: Place this code AFTER the successful `updateMany` but BEFORE the `revalidatePath` calls.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Grep for "TODO: Phase 9" in the file - should return no results.
  </verify>
  <done>
submitBatchAction sends email to SA on submit, differentiates between new submission (NOTIF-01) and resubmission (NOTIF-05), failures are logged but don't block the action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add email notifications to approveDescriptorAction and returnDescriptorAction (NOTIF-02/03/04)</name>
  <files>src/app/(dashboard)/hub/descriptors/pending-review/actions.ts</files>
  <action>
Modify `src/app/(dashboard)/hub/descriptors/pending-review/actions.ts`:

1. Add import at top:
```typescript
import {
  sendDescriptorApprovedNotification,
  sendDescriptorReturnedNotification,
} from "@/lib/email/descriptor-notifications";
```

2. In `approveDescriptorAction`, after the successful prisma.descriptor.update (after line 106, before revalidatePath):
```typescript
// Send approval notification to SCM (non-blocking) - NOTIF-02/03
try {
  const descriptor = await prisma.descriptor.findUnique({
    where: { id },
    select: {
      criterionName: true,
      createdBy: { select: { email: true } },
    },
  });

  if (descriptor?.createdBy?.email) {
    await sendDescriptorApprovedNotification({
      to: descriptor.createdBy.email,
      criterionName: descriptor.criterionName,
      saName: user.name ?? "Your Skill Advisor",
      wasModified,
    });
  }
} catch (error) {
  console.error("Failed to send approval notification", {
    descriptorId: id,
    error,
  });
}
```

3. In `returnDescriptorAction`, after the successful prisma.descriptor.update (after line 163, before revalidatePath):
```typescript
// Send return notification to SCM (non-blocking) - NOTIF-04
try {
  const descriptor = await prisma.descriptor.findUnique({
    where: { id },
    select: {
      criterionName: true,
      createdBy: { select: { email: true } },
    },
  });

  if (descriptor?.createdBy?.email) {
    await sendDescriptorReturnedNotification({
      to: descriptor.createdBy.email,
      criterionName: descriptor.criterionName,
      saName: user.name ?? "Your Skill Advisor",
      comment,
    });
  }
} catch (error) {
  console.error("Failed to send return notification", {
    descriptorId: id,
    error,
  });
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Both functions have email notification code wrapped in try/catch.
  </verify>
  <done>
approveDescriptorAction sends email to SCM on approval with modification flag (NOTIF-02/03), returnDescriptorAction sends email to SCM with SA comment (NOTIF-04), all wrapped in try/catch for non-blocking behavior.
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] submitBatchAction imports and uses sendBatchSubmittedNotification and sendDescriptorsResubmittedNotification
- [ ] approveDescriptorAction imports and uses sendDescriptorApprovedNotification
- [ ] returnDescriptorAction imports and uses sendDescriptorReturnedNotification
- [ ] All email sends are wrapped in try/catch with console.error on failure
- [ ] No TODO comments remain related to Phase 9
</verification>

<success_criteria>
1. NOTIF-01: SA receives email when SCM submits new batch
2. NOTIF-02: SCM receives email when SA approves (no modification)
3. NOTIF-03: SCM receives email when SA approves with modifications (wasModified flag)
4. NOTIF-04: SCM receives email when SA returns with comment
5. NOTIF-05: SA receives email when SCM resubmits revised descriptors
6. All notifications are non-blocking (try/catch, log failures)
</success_criteria>

<output>
After completion, create `.planning/phases/09-email-notifications/09-02-SUMMARY.md`
</output>
