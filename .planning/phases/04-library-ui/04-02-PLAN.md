---
phase: 04-library-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/descriptors/page.tsx
  - src/app/descriptors/components/DescriptorList.tsx
  - src/app/descriptors/components/ComparisonBar.tsx
  - src/app/descriptors/components/ComparisonModal.tsx
  - src/components/ui/checkbox.tsx
autonomous: true

must_haves:
  truths:
    - "Users can select 2-3 descriptors for side-by-side comparison"
    - "Comparison view shows all performance levels aligned horizontally"
    - "Selection state persists while browsing/filtering"
    - "Clear visual indication of selected descriptors"
  artifacts:
    - path: "src/app/descriptors/components/ComparisonModal.tsx"
      provides: "Side-by-side comparison view"
      min_lines: 80
    - path: "src/app/descriptors/components/ComparisonBar.tsx"
      provides: "Floating bar showing selected count and compare button"
      min_lines: 30
    - path: "src/components/ui/checkbox.tsx"
      provides: "Checkbox component for selection"
      contains: "CheckboxPrimitive"
  key_links:
    - from: "DescriptorList.tsx"
      to: "selection state"
      via: "checkbox onChange updates selected array"
      pattern: "setSelected"
    - from: "ComparisonBar.tsx"
      to: "ComparisonModal.tsx"
      via: "Compare button opens modal"
      pattern: "onClick.*setCompareOpen"
---

<objective>
Implement multi-select and side-by-side comparison view for descriptors

Purpose: Enable users to compare 2-3 descriptors side-by-side (UI-09) using multi-select pattern (UI-10)
Output: Checkbox selection on cards, floating comparison bar, side-by-side comparison modal
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/descriptors/page.tsx
@src/app/descriptors/components/DescriptorList.tsx
@src/app/descriptors/components/DescriptorModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix Checkbox and create component</name>
  <files>src/components/ui/checkbox.tsx</files>
  <action>
Install Radix checkbox primitive:

```bash
pnpm add @radix-ui/react-checkbox
```

Create the checkbox component following shadcn pattern:

```typescript
"use client";

import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { Check } from "lucide-react";

import { cn } from "@/lib/utils";

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };
```
  </action>
  <verify>
Checkbox component exists and TypeScript compiles.
  </verify>
  <done>Checkbox component created</done>
</task>

<task type="auto">
  <name>Task 2: Create ComparisonBar component</name>
  <files>src/app/descriptors/components/ComparisonBar.tsx</files>
  <action>
Create a floating bar that appears when descriptors are selected:

```typescript
"use client";

import { Button } from "@/components/ui/button";
import { X, GitCompare } from "lucide-react";
import type { SearchResult } from "@/lib/search-descriptors";

interface ComparisonBarProps {
  selected: SearchResult[];
  onClear: () => void;
  onCompare: () => void;
  onRemove: (id: string) => void;
}

export function ComparisonBar({ selected, onClear, onCompare, onRemove }: ComparisonBarProps) {
  if (selected.length === 0) return null;

  const canCompare = selected.length >= 2 && selected.length <= 3;

  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-background border rounded-lg shadow-lg p-4 flex items-center gap-4">
      <div className="flex items-center gap-2">
        <span className="text-sm font-medium">
          {selected.length} selected
        </span>
        <div className="flex gap-1">
          {selected.map((d) => (
            <div
              key={d.id}
              className="flex items-center gap-1 bg-muted px-2 py-1 rounded text-xs"
            >
              <span className="max-w-[100px] truncate">{d.criterionName}</span>
              <button
                onClick={() => onRemove(d.id)}
                className="hover:text-destructive"
              >
                <X className="h-3 w-3" />
              </button>
            </div>
          ))}
        </div>
      </div>

      <div className="flex gap-2">
        <Button variant="outline" size="sm" onClick={onClear}>
          Clear
        </Button>
        <Button
          size="sm"
          onClick={onCompare}
          disabled={!canCompare}
          title={!canCompare ? "Select 2-3 descriptors to compare" : "Compare selected"}
        >
          <GitCompare className="h-4 w-4 mr-2" />
          Compare {canCompare ? `(${selected.length})` : ""}
        </Button>
      </div>
    </div>
  );
}
```

Key features:
- Fixed position at bottom center
- Shows selected descriptor names (truncated)
- Individual remove buttons
- Compare button enabled only for 2-3 selections
- Clear all button
  </action>
  <verify>
Component renders when selections exist.
  </verify>
  <done>ComparisonBar component created</done>
</task>

<task type="auto">
  <name>Task 3: Create ComparisonModal component</name>
  <files>src/app/descriptors/components/ComparisonModal.tsx</files>
  <action>
Create the side-by-side comparison modal:

```typescript
"use client";

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Copy, Check } from "lucide-react";
import { useState } from "react";
import { useToast } from "@/hooks/use-toast";
import type { SearchResult } from "@/lib/search-descriptors";

interface ComparisonModalProps {
  descriptors: SearchResult[];
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function ComparisonModal({ descriptors, open, onOpenChange }: ComparisonModalProps) {
  const { toast } = useToast();
  const [copiedId, setCopiedId] = useState<string | null>(null);

  const copyLevel = async (text: string, id: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedId(id);
      toast({ title: "Copied to clipboard" });
      setTimeout(() => setCopiedId(null), 2000);
    } catch {
      toast({ title: "Copy failed", variant: "destructive" });
    }
  };

  const colWidth = descriptors.length === 2 ? "w-1/2" : "w-1/3";

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Compare Descriptors</DialogTitle>
        </DialogHeader>

        <div className="flex gap-4 mt-4">
          {descriptors.map((d) => (
            <div key={d.id} className={`${colWidth} space-y-3`}>
              {/* Header */}
              <div className="border-b pb-2">
                <h3 className="font-semibold text-sm line-clamp-2">{d.criterionName}</h3>
                <div className="flex flex-wrap gap-1 mt-1">
                  <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200">
                    {d.skillName}
                  </Badge>
                  {d.category && (
                    <Badge variant="outline" className="text-xs">{d.category}</Badge>
                  )}
                </div>
              </div>

              {/* Performance Levels */}
              <LevelSection
                label="Excellent"
                text={d.excellent}
                color="green"
                onCopy={() => d.excellent && copyLevel(d.excellent, `${d.id}-excellent`)}
                copied={copiedId === `${d.id}-excellent`}
              />
              <LevelSection
                label="Good"
                text={d.good}
                color="blue"
                onCopy={() => d.good && copyLevel(d.good, `${d.id}-good`)}
                copied={copiedId === `${d.id}-good`}
              />
              <LevelSection
                label="Pass"
                text={d.pass}
                color="yellow"
                onCopy={() => d.pass && copyLevel(d.pass, `${d.id}-pass`)}
                copied={copiedId === `${d.id}-pass`}
              />
              <LevelSection
                label="Below Pass"
                text={d.belowPass}
                color="red"
                onCopy={() => d.belowPass && copyLevel(d.belowPass, `${d.id}-below`)}
                copied={copiedId === `${d.id}-below`}
              />
            </div>
          ))}
        </div>
      </DialogContent>
    </Dialog>
  );
}

function LevelSection({
  label,
  text,
  color,
  onCopy,
  copied,
}: {
  label: string;
  text: string | null;
  color: "green" | "blue" | "yellow" | "red";
  onCopy: () => void;
  copied: boolean;
}) {
  if (!text) {
    return (
      <div className="text-xs text-muted-foreground italic p-2 bg-muted/30 rounded">
        No {label.toLowerCase()} level
      </div>
    );
  }

  const colorClasses = {
    green: "bg-green-50/50 border-green-200",
    blue: "bg-blue-50/50 border-blue-200",
    yellow: "bg-yellow-50/50 border-yellow-200",
    red: "bg-red-50/50 border-red-200",
  };

  const labelColors = {
    green: "text-green-700",
    blue: "text-blue-700",
    yellow: "text-yellow-700",
    red: "text-red-700",
  };

  return (
    <div className={`border rounded p-2 ${colorClasses[color]}`}>
      <div className="flex items-center justify-between mb-1">
        <span className={`text-xs font-semibold ${labelColors[color]}`}>{label}</span>
        <Button variant="ghost" size="sm" className="h-5 w-5 p-0" onClick={onCopy}>
          {copied ? <Check className="h-3 w-3 text-green-500" /> : <Copy className="h-3 w-3" />}
        </Button>
      </div>
      <p className="text-xs leading-relaxed">{text}</p>
    </div>
  );
}
```

Key features:
- Side-by-side columns (2 or 3)
- Aligned performance levels for easy comparison
- Color-coded levels matching card/modal styling
- Individual copy buttons per level
- Handles missing levels gracefully
  </action>
  <verify>
Modal shows 2-3 descriptors side by side.
  </verify>
  <done>ComparisonModal component created</done>
</task>

<task type="auto">
  <name>Task 4: Update DescriptorList with selection state</name>
  <files>src/app/descriptors/components/DescriptorList.tsx</files>
  <action>
Update DescriptorList to:
1. Manage selection state (array of selected descriptors)
2. Add checkbox to each card
3. Render ComparisonBar and ComparisonModal
4. Limit selection to 3 descriptors max

Key changes:
- Add `selected` state array
- Add `toggleSelect` function that checks max 3 limit
- Add checkbox to card header
- Render ComparisonBar at bottom
- Render ComparisonModal when compare clicked
- Checkbox click should stopPropagation (don't open detail modal)

The checkbox should appear at the left of the card header, before the title.
When a card is selected, it should have a visual highlight (e.g., border color change).
  </action>
  <verify>
Checkboxes appear on cards.
Selection works up to 3 items.
ComparisonBar appears when items selected.
Compare opens modal with selected items.
  </verify>
  <done>DescriptorList updated with multi-select and comparison</done>
</task>

</tasks>

<verification>
1. Click checkbox on card - card is selected (visual highlight)
2. Select 2-3 cards - comparison bar appears at bottom
3. Click "Compare" - modal opens with side-by-side view
4. Performance levels aligned horizontally for comparison
5. Copy individual levels from comparison view
6. Clear selection - comparison bar disappears
7. Selection persists during search/filter changes (within page)
8. Max 3 selections enforced (4th click shows toast warning)
</verification>

<success_criteria>
- Multi-select with checkboxes (UI-10)
- Side-by-side comparison view (UI-09)
- Max 3 descriptors for comparison
- Clear visual indication of selected state
- Copy functionality in comparison view
</success_criteria>

<output>
After completion, create `.planning/phases/04-library-ui/04-02-SUMMARY.md`
</output>
