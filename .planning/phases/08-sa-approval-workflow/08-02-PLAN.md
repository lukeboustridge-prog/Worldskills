---
phase: 08-sa-approval-workflow
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/lib/sa-approval.ts
autonomous: true

must_haves:
  truths:
    - "SA can query pending descriptors from their skill's SCMs only"
    - "Query returns descriptors with PENDING_REVIEW status"
    - "SA authorization check verifies SCM-SA relationship via Skill"
  artifacts:
    - path: "src/lib/sa-approval.ts"
      provides: "SA approval query utilities"
      exports: ["getPendingDescriptorsForSA", "getPendingCountsForSA", "canSAReviewDescriptor"]
      min_lines: 80
  key_links:
    - from: "src/lib/sa-approval.ts"
      to: "prisma.skill"
      via: "findMany where saId = userId"
      pattern: "saId.*user"
    - from: "src/lib/sa-approval.ts"
      to: "prisma.descriptor"
      via: "findMany where createdById in scmIds"
      pattern: "createdById.*in.*scmIds"
---

<objective>
Create SA approval query utilities for fetching pending descriptors filtered by skill relationship.

Purpose: APPR-01 requires SA to see only descriptors from their skill's SCM. This requires querying through the Skill model to find SCMs assigned to the SA, then filtering descriptors by those SCM IDs.
Output: Query functions in src/lib/sa-approval.ts ready for Server Actions.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\LukeBoustridge\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-sa-approval-workflow/08-RESEARCH.md

# Pattern reference
@src/lib/scm-descriptors.ts

# Current schema (for Skill and Descriptor relationships)
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SA approval query utilities</name>
  <files>src/lib/sa-approval.ts</files>
  <action>
Create new file `src/lib/sa-approval.ts` with three functions following the pattern from `src/lib/scm-descriptors.ts`.

```typescript
import { DescriptorBatchStatus } from "@prisma/client";
import { prisma } from "@/lib/prisma";

/**
 * Get pending descriptors for SA to review.
 * Implements APPR-01: SA sees pending descriptors from their skill's SCM.
 *
 * Flow:
 * 1. Find all skills where this SA is assigned (saId = userId)
 * 2. Extract SCM IDs from those skills
 * 3. Find PENDING_REVIEW descriptors created by those SCMs
 */
export async function getPendingDescriptorsForSA(saUserId: string) {
  // Find all SCM user IDs for skills this SA manages
  const skills = await prisma.skill.findMany({
    where: { saId: saUserId },
    select: { scmId: true, name: true },
  });

  const scmIds = skills
    .map((s) => s.scmId)
    .filter((id): id is string => id !== null);

  if (scmIds.length === 0) {
    return [];
  }

  // Find PENDING_REVIEW descriptors created by those SCMs
  return prisma.descriptor.findMany({
    where: {
      createdById: { in: scmIds },
      batchStatus: DescriptorBatchStatus.PENDING_REVIEW,
      deletedAt: null,
    },
    include: {
      wsosSection: {
        select: { id: true, name: true },
      },
      createdBy: {
        select: { id: true, name: true, email: true },
      },
    },
    orderBy: [
      { submittedAt: "asc" }, // Oldest first (FIFO review)
      { createdAt: "asc" },
    ],
  });
}

export type PendingDescriptor = Awaited<
  ReturnType<typeof getPendingDescriptorsForSA>
>[number];

/**
 * Get counts of pending descriptors for SA.
 * Useful for badge counts in navigation.
 */
export async function getPendingCountsForSA(saUserId: string) {
  const skills = await prisma.skill.findMany({
    where: { saId: saUserId },
    select: { scmId: true },
  });

  const scmIds = skills
    .map((s) => s.scmId)
    .filter((id): id is string => id !== null);

  if (scmIds.length === 0) {
    return { total: 0 };
  }

  const count = await prisma.descriptor.count({
    where: {
      createdById: { in: scmIds },
      batchStatus: DescriptorBatchStatus.PENDING_REVIEW,
      deletedAt: null,
    },
  });

  return { total: count };
}

/**
 * Check if SA can review a specific descriptor.
 * Validates:
 * 1. Descriptor exists and is in PENDING_REVIEW status
 * 2. Descriptor was created by an SCM assigned to a skill the SA manages
 */
export async function canSAReviewDescriptor(
  saUserId: string,
  descriptorId: string
): Promise<boolean> {
  const descriptor = await prisma.descriptor.findUnique({
    where: { id: descriptorId },
    select: { createdById: true, batchStatus: true },
  });

  if (!descriptor?.createdById) return false;
  if (descriptor.batchStatus !== DescriptorBatchStatus.PENDING_REVIEW)
    return false;

  // Check if SA manages a skill with this SCM
  const skill = await prisma.skill.findFirst({
    where: {
      saId: saUserId,
      scmId: descriptor.createdById,
    },
  });

  return skill !== null;
}
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. File exports all three functions
3. Types are correctly inferred (PendingDescriptor includes wsosSection, createdBy)
  </verify>
  <done>SA approval query utilities created with getPendingDescriptorsForSA, getPendingCountsForSA, and canSAReviewDescriptor functions.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Functions use correct Prisma queries for SA-SCM relationship
3. Exports match expected: getPendingDescriptorsForSA, getPendingCountsForSA, canSAReviewDescriptor
4. PendingDescriptor type exported
</verification>

<success_criteria>
- [ ] src/lib/sa-approval.ts exists with 3 exported functions
- [ ] getPendingDescriptorsForSA queries through Skill.saId relationship
- [ ] canSAReviewDescriptor validates SA-SCM relationship before allowing review
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sa-approval-workflow/08-02-SUMMARY.md`
</output>
