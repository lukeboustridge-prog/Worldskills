---
phase: 08-sa-approval-workflow
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/(dashboard)/hub/descriptors/pending-review/actions.ts
  - src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts
autonomous: true

must_haves:
  truths:
    - "SA can approve descriptor (status changes to APPROVED, qualityIndicator to GOOD)"
    - "SA can edit descriptor wording before approving"
    - "System sets wasModifiedDuringApproval flag when SA changes wording"
    - "SA can return descriptor with rejection comment"
    - "SCM can edit RETURNED descriptors and resubmit"
  artifacts:
    - path: "src/app/(dashboard)/hub/descriptors/pending-review/actions.ts"
      provides: "SA approval and return Server Actions"
      exports: ["approveDescriptorAction", "returnDescriptorAction"]
      min_lines: 80
    - path: "src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts"
      provides: "Extended SCM actions for RETURNED descriptors"
      exports: ["updateReturnedDescriptorAction"]
  key_links:
    - from: "pending-review/actions.ts"
      to: "src/lib/sa-approval.ts"
      via: "canSAReviewDescriptor"
      pattern: "canSAReviewDescriptor"
    - from: "pending-review/actions.ts"
      to: "prisma.descriptor.update"
      via: "batchStatus = APPROVED"
      pattern: "DescriptorBatchStatus\\.APPROVED"
---

<objective>
Create Server Actions for SA approval workflow and extend SCM actions for RETURNED descriptor handling.

Purpose: Implement core business logic for APPR-02 through APPR-06 - SA approve/return actions with modification tracking, and SCM resubmit flow.
Output: Server Actions ready for UI integration.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\LukeBoustridge\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-sa-approval-workflow/08-RESEARCH.md

# Pattern reference
@src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts

# Query utilities (created in plan 02)
# @src/lib/sa-approval.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SA approval Server Actions</name>
  <files>src/app/(dashboard)/hub/descriptors/pending-review/actions.ts</files>
  <action>
Create new directory and file for SA approval actions.

```bash
mkdir -p src/app/(dashboard)/hub/descriptors/pending-review
```

Create `actions.ts` with approveDescriptorAction and returnDescriptorAction:

```typescript
"use server";

import { DescriptorBatchStatus, QualityIndicator } from "@prisma/client";
import { revalidatePath } from "next/cache";
import { z } from "zod";

import { requireUser } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { canSAReviewDescriptor } from "@/lib/sa-approval";

const approveDescriptorSchema = z.object({
  id: z.string().min(1, "Descriptor ID required"),
  // Optional edits - if provided, wording was changed
  criterionName: z.string().optional(),
  score3: z.string().optional(),
  score2: z.string().optional(),
  score1: z.string().optional(),
  score0: z.string().optional(),
});

/**
 * Approve a descriptor with optional wording edits.
 * Implements APPR-02, APPR-03, APPR-04:
 * - Changes batchStatus to APPROVED
 * - Changes qualityIndicator to GOOD
 * - Sets reviewerId and reviewedAt
 * - Sets wasModifiedDuringApproval if any wording field changed
 */
export async function approveDescriptorAction(formData: FormData) {
  const user = await requireUser();

  // Only SAs can approve
  if (user.role !== "SA") {
    return { error: "Only Skill Advisors can approve descriptors" };
  }

  const parsed = approveDescriptorSchema.safeParse({
    id: formData.get("id"),
    criterionName: formData.get("criterionName") || undefined,
    score3: formData.get("score3") || undefined,
    score2: formData.get("score2") || undefined,
    score1: formData.get("score1") || undefined,
    score0: formData.get("score0") || undefined,
  });

  if (!parsed.success) {
    return { error: parsed.error.errors[0]?.message ?? "Invalid input" };
  }

  const { id, criterionName, score3, score2, score1, score0 } = parsed.data;

  // Verify SA can review this descriptor (APPR-01 check)
  const canReview = await canSAReviewDescriptor(user.id, id);
  if (!canReview) {
    return { error: "You do not have permission to review this descriptor" };
  }

  // Fetch current descriptor to compare wording for modification detection
  const current = await prisma.descriptor.findUnique({
    where: { id },
    select: {
      criterionName: true,
      score3: true,
      score2: true,
      score1: true,
      score0: true,
    },
  });

  if (!current) {
    return { error: "Descriptor not found" };
  }

  // Detect if any wording was modified (APPR-04)
  const wasModified =
    (criterionName !== undefined &&
      criterionName.trim() !== current.criterionName) ||
    (score3 !== undefined && score3.trim() !== (current.score3 || "")) ||
    (score2 !== undefined && score2.trim() !== (current.score2 || "")) ||
    (score1 !== undefined && score1.trim() !== (current.score1 || "")) ||
    (score0 !== undefined && score0.trim() !== (current.score0 || ""));

  try {
    await prisma.descriptor.update({
      where: { id },
      data: {
        // Update wording if provided
        ...(criterionName !== undefined && {
          criterionName: criterionName.trim(),
        }),
        ...(score3 !== undefined && { score3: score3.trim() || null }),
        ...(score2 !== undefined && { score2: score2.trim() || null }),
        ...(score1 !== undefined && { score1: score1.trim() || null }),
        ...(score0 !== undefined && { score0: score0.trim() || null }),

        // Approval fields (APPR-02)
        batchStatus: DescriptorBatchStatus.APPROVED,
        qualityIndicator: QualityIndicator.GOOD,
        reviewerId: user.id,
        reviewedAt: new Date(),
        wasModifiedDuringApproval: wasModified,

        // Clear any previous return comment
        reviewComment: null,
      },
    });
  } catch (error) {
    console.error("Failed to approve descriptor", error);
    return { error: "Failed to approve descriptor" };
  }

  revalidatePath("/hub/descriptors/pending-review");
  revalidatePath("/hub/descriptors/my-descriptors");

  return { success: true, wasModified };
}

const returnDescriptorSchema = z.object({
  id: z.string().min(1, "Descriptor ID required"),
  comment: z.string().min(5, "Please provide a reason (at least 5 characters)"),
});

/**
 * Return a descriptor to SCM with comments.
 * Implements APPR-05:
 * - Changes batchStatus to RETURNED
 * - Keeps qualityIndicator as NEEDS_REVIEW
 * - Sets reviewerId, reviewedAt, and reviewComment
 */
export async function returnDescriptorAction(formData: FormData) {
  const user = await requireUser();

  if (user.role !== "SA") {
    return { error: "Only Skill Advisors can return descriptors" };
  }

  const parsed = returnDescriptorSchema.safeParse({
    id: formData.get("id"),
    comment: formData.get("comment"),
  });

  if (!parsed.success) {
    return { error: parsed.error.errors[0]?.message ?? "Invalid input" };
  }

  const { id, comment } = parsed.data;

  const canReview = await canSAReviewDescriptor(user.id, id);
  if (!canReview) {
    return { error: "You do not have permission to return this descriptor" };
  }

  try {
    await prisma.descriptor.update({
      where: { id },
      data: {
        batchStatus: DescriptorBatchStatus.RETURNED,
        // Keep qualityIndicator as NEEDS_REVIEW (not GOOD)
        reviewerId: user.id,
        reviewedAt: new Date(),
        reviewComment: comment.trim(),
      },
    });
  } catch (error) {
    console.error("Failed to return descriptor", error);
    return { error: "Failed to return descriptor" };
  }

  revalidatePath("/hub/descriptors/pending-review");
  revalidatePath("/hub/descriptors/my-descriptors");

  return { success: true };
}
```
  </action>
  <verify>
1. Directory exists: `ls src/app/(dashboard)/hub/descriptors/pending-review/`
2. TypeScript compiles: `npx tsc --noEmit`
3. Actions export correctly
  </verify>
  <done>SA approval actions created with approveDescriptorAction (sets APPROVED + GOOD + wasModified) and returnDescriptorAction (sets RETURNED + comment).</done>
</task>

<task type="auto">
  <name>Task 2: Extend SCM actions for RETURNED descriptors</name>
  <files>src/app/(dashboard)/hub/descriptors/my-descriptors/actions.ts</files>
  <action>
Add updateReturnedDescriptorAction to existing SCM actions file.

Add after the existing deleteSCMDescriptorAction function (around line 254):

```typescript
/**
 * Update a RETURNED descriptor (SCM revising after SA feedback).
 * Implements APPR-06: SCM can edit and resubmit returned descriptors.
 *
 * Behavior:
 * - Only allowed for RETURNED status descriptors owned by user
 * - Saves edits and changes status back to DRAFT
 * - Clears reviewer fields so SCM can resubmit fresh
 * - SCM must click "Submit for Review" to resend to SA
 */
export async function updateReturnedDescriptorAction(formData: FormData) {
  const user = await requireUser();

  if (user.role !== "SCM") {
    throw new Error("Only SCMs can update returned descriptors");
  }

  const parsed = updateSCMDescriptorSchema.safeParse({
    id: formData.get("id"),
    code: formData.get("code"),
    criterionName: formData.get("criterionName"),
    wsosSectionId: formData.get("wsosSectionId"),
    score3: formData.get("score3") || undefined,
    score2: formData.get("score2") || undefined,
    score1: formData.get("score1") || undefined,
    score0: formData.get("score0") || undefined,
    tags: formData.get("tags") || undefined,
  });

  if (!parsed.success) {
    const error = parsed.error.errors[0]?.message ?? "Invalid input";
    const id = formData.get("id") as string;
    const params = new URLSearchParams({ error });
    return redirect(`/hub/descriptors/my-descriptors/${id}/edit?${params.toString()}`);
  }

  const data = parsed.data;
  const tags = parseCommaSeparated(data.tags);

  // Verify ownership and RETURNED status (different from DRAFT check)
  const existing = await prisma.descriptor.findFirst({
    where: {
      id: data.id,
      createdById: user.id,
      batchStatus: DescriptorBatchStatus.RETURNED,
      deletedAt: null,
    },
  });

  if (!existing) {
    const params = new URLSearchParams({ error: "Descriptor not found or cannot be edited" });
    return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
  }

  try {
    // Update and change status back to DRAFT for resubmission
    // Clear reviewer fields so SCM can resubmit fresh
    await prisma.$executeRaw`
      UPDATE "Descriptor"
      SET
        code = ${data.code.trim()},
        "criterionName" = ${data.criterionName.trim()},
        score3 = ${data.score3?.trim() || null},
        score2 = ${data.score2?.trim() || null},
        score1 = ${data.score1?.trim() || null},
        score0 = ${data.score0?.trim() || null},
        "wsosSectionId" = ${data.wsosSectionId},
        tags = ${tags}::text[],
        "batchStatus" = ${DescriptorBatchStatus.DRAFT}::"DescriptorBatchStatus",
        "reviewComment" = NULL,
        "reviewerId" = NULL,
        "reviewedAt" = NULL,
        "updatedAt" = NOW()
      WHERE id = ${data.id}
    `;
  } catch (error) {
    console.error("Failed to update returned descriptor", error);
    const params = new URLSearchParams({ error: "Failed to update descriptor" });
    return redirect(`/hub/descriptors/my-descriptors/${data.id}/edit?${params.toString()}`);
  }

  revalidatePath("/hub/descriptors/my-descriptors");
  const params = new URLSearchParams({ updated: "1" });
  return redirect(`/hub/descriptors/my-descriptors?${params.toString()}`);
}
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. New action exported from file
3. Status transition: RETURNED -> DRAFT (not directly to PENDING_REVIEW)
  </verify>
  <done>SCM actions extended with updateReturnedDescriptorAction that allows editing RETURNED descriptors and moves them back to DRAFT for resubmission.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. SA actions: approveDescriptorAction sets batchStatus=APPROVED, qualityIndicator=GOOD
3. SA actions: returnDescriptorAction sets batchStatus=RETURNED, reviewComment set
4. SCM actions: updateReturnedDescriptorAction changes RETURNED to DRAFT, clears review fields
5. All actions use canSAReviewDescriptor or ownership checks
</verification>

<success_criteria>
- [ ] approveDescriptorAction sets batchStatus=APPROVED and qualityIndicator=GOOD
- [ ] approveDescriptorAction sets wasModifiedDuringApproval=true when wording changed
- [ ] returnDescriptorAction sets batchStatus=RETURNED and stores reviewComment
- [ ] updateReturnedDescriptorAction allows SCM to edit RETURNED descriptors
- [ ] updateReturnedDescriptorAction moves descriptor back to DRAFT status
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sa-approval-workflow/08-03-SUMMARY.md`
</output>
