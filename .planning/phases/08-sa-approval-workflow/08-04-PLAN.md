---
phase: 08-sa-approval-workflow
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/app/(dashboard)/hub/descriptors/pending-review/page.tsx
  - src/app/(dashboard)/hub/descriptors/pending-review/components/PendingReviewCard.tsx
  - src/app/(dashboard)/hub/descriptors/my-descriptors/page.tsx
  - src/app/(dashboard)/hub/descriptors/my-descriptors/[id]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "SA can access /hub/descriptors/pending-review page"
    - "SA sees list of pending descriptors from their skill's SCM"
    - "SA can approve descriptor without changes"
    - "SA can edit descriptor wording then approve"
    - "SA can return descriptor with comment via dialog"
    - "SCM sees edit button on RETURNED descriptors"
    - "SCM can edit RETURNED descriptor and it moves to DRAFT"
  artifacts:
    - path: "src/app/(dashboard)/hub/descriptors/pending-review/page.tsx"
      provides: "SA pending review page"
      min_lines: 50
    - path: "src/app/(dashboard)/hub/descriptors/pending-review/components/PendingReviewCard.tsx"
      provides: "Expandable card with approve/edit/return actions"
      min_lines: 100
    - path: "src/app/(dashboard)/hub/descriptors/my-descriptors/page.tsx"
      provides: "Extended SCM page with edit for RETURNED"
      contains: "updateReturnedDescriptorAction"
    - path: "src/app/(dashboard)/hub/descriptors/my-descriptors/[id]/edit/page.tsx"
      provides: "Edit page allowing DRAFT and RETURNED status"
      contains: "RETURNED"
  key_links:
    - from: "pending-review/page.tsx"
      to: "src/lib/sa-approval.ts"
      via: "getPendingDescriptorsForSA"
      pattern: "getPendingDescriptorsForSA"
    - from: "PendingReviewCard.tsx"
      to: "pending-review/actions.ts"
      via: "approveDescriptorAction, returnDescriptorAction"
      pattern: "approveDescriptorAction"
    - from: "my-descriptors/page.tsx"
      to: "my-descriptors/actions.ts"
      via: "edit link for RETURNED"
      pattern: "RETURNED.*edit"
---

<objective>
Build SA pending review UI page and extend SCM page for RETURNED descriptor editing.

Purpose: Complete the visual interface for APPR-01 through APPR-06 - SA can view, approve, edit, and return descriptors; SCM can see and edit returned descriptors.
Output: Functional SA approval page and updated SCM page.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\LukeBoustridge\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-sa-approval-workflow/08-RESEARCH.md

# Pattern reference
@src/app/(dashboard)/hub/descriptors/my-descriptors/page.tsx
@src/app/(dashboard)/hub/descriptors/my-descriptors/[id]/edit/page.tsx

# Query utilities and actions (from plans 02 and 03)
# @src/lib/sa-approval.ts
# @src/app/(dashboard)/hub/descriptors/pending-review/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SA pending review page</name>
  <files>src/app/(dashboard)/hub/descriptors/pending-review/page.tsx</files>
  <action>
Create the SA pending review page at `src/app/(dashboard)/hub/descriptors/pending-review/page.tsx`:

```typescript
import { redirect } from "next/navigation";
import Link from "next/link";
import { ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { requireUser } from "@/lib/auth";
import { getPendingDescriptorsForSA, getPendingCountsForSA } from "@/lib/sa-approval";
import { PendingReviewCard } from "./components/PendingReviewCard";

export default async function PendingReviewPage() {
  const user = await requireUser();

  // Only SAs can access this page
  if (user.role !== "SA") {
    redirect("/dashboard");
  }

  const [descriptors, counts] = await Promise.all([
    getPendingDescriptorsForSA(user.id),
    getPendingCountsForSA(user.id),
  ]);

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button asChild variant="ghost" size="sm">
          <Link href="/hub/descriptors">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Back to Library
          </Link>
        </Button>
      </div>

      <div>
        <h1 className="text-3xl font-semibold tracking-tight">
          Pending Review
        </h1>
        <p className="mt-2 text-muted-foreground">
          Review descriptors submitted by your SCMs. Approve, edit, or return
          with feedback.
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Descriptors Awaiting Review</CardTitle>
          <CardDescription>
            {counts.total} descriptor(s) pending your review
          </CardDescription>
        </CardHeader>
        <CardContent>
          {descriptors.length === 0 ? (
            <p className="text-sm text-muted-foreground py-8 text-center">
              No descriptors pending review.
            </p>
          ) : (
            <div className="space-y-3">
              {descriptors.map((descriptor) => (
                <PendingReviewCard key={descriptor.id} descriptor={descriptor} />
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
File exists and exports default function PendingReviewPage.
  </verify>
  <done>SA pending review page created with descriptor list from getPendingDescriptorsForSA.</done>
</task>

<task type="auto">
  <name>Task 2: Create PendingReviewCard component</name>
  <files>src/app/(dashboard)/hub/descriptors/pending-review/components/PendingReviewCard.tsx</files>
  <action>
Create directory and component file:

```bash
mkdir -p src/app/(dashboard)/hub/descriptors/pending-review/components
```

Create `PendingReviewCard.tsx` with expandable card, inline editing, approve/return actions:

```typescript
"use client";

import { useState, useTransition } from "react";
import {
  Check,
  ChevronDown,
  ChevronRight,
  Loader2,
  Pencil,
  X,
  Undo2,
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { useToast } from "@/hooks/use-toast";
import { approveDescriptorAction, returnDescriptorAction } from "../actions";
import type { PendingDescriptor } from "@/lib/sa-approval";

interface PendingReviewCardProps {
  descriptor: PendingDescriptor;
}

export function PendingReviewCard({ descriptor }: PendingReviewCardProps) {
  const { toast } = useToast();
  const [isPending, startTransition] = useTransition();
  const [expanded, setExpanded] = useState(false);
  const [editing, setEditing] = useState(false);
  const [processed, setProcessed] = useState(false);

  // Form state for editing
  const [criterionName, setCriterionName] = useState(descriptor.criterionName);
  const [score3, setScore3] = useState(descriptor.score3 || "");
  const [score2, setScore2] = useState(descriptor.score2 || "");
  const [score1, setScore1] = useState(descriptor.score1 || "");
  const [score0, setScore0] = useState(descriptor.score0 || "");

  // Return comment state
  const [returnComment, setReturnComment] = useState("");
  const [dialogOpen, setDialogOpen] = useState(false);

  const handleApprove = () => {
    const formData = new FormData();
    formData.set("id", descriptor.id);

    // Include edits if in editing mode
    if (editing) {
      formData.set("criterionName", criterionName);
      formData.set("score3", score3);
      formData.set("score2", score2);
      formData.set("score1", score1);
      formData.set("score0", score0);
    }

    startTransition(async () => {
      const result = await approveDescriptorAction(formData);
      if (result.error) {
        toast({
          title: "Error",
          description: result.error,
          variant: "destructive",
        });
      } else {
        const message = result.wasModified
          ? "Descriptor approved with modifications"
          : "Descriptor approved";
        toast({ title: "Approved", description: message });
        setProcessed(true);
      }
    });
  };

  const handleReturn = () => {
    const formData = new FormData();
    formData.set("id", descriptor.id);
    formData.set("comment", returnComment);

    startTransition(async () => {
      const result = await returnDescriptorAction(formData);
      if (result.error) {
        toast({
          title: "Error",
          description: result.error,
          variant: "destructive",
        });
      } else {
        toast({
          title: "Returned",
          description: "Descriptor returned to SCM with your feedback",
        });
        setDialogOpen(false);
        setProcessed(true);
      }
    });
  };

  const handleCancelEdit = () => {
    setCriterionName(descriptor.criterionName);
    setScore3(descriptor.score3 || "");
    setScore2(descriptor.score2 || "");
    setScore1(descriptor.score1 || "");
    setScore0(descriptor.score0 || "");
    setEditing(false);
  };

  // Don't render if already processed
  if (processed) {
    return null;
  }

  return (
    <Card>
      <CardHeader className="pb-2">
        <div className="flex items-start gap-3">
          <button
            onClick={() => setExpanded(!expanded)}
            className="text-muted-foreground hover:text-foreground shrink-0 mt-1"
          >
            {expanded ? (
              <ChevronDown className="h-4 w-4" />
            ) : (
              <ChevronRight className="h-4 w-4" />
            )}
          </button>

          <div className="flex-1 min-w-0">
            {editing ? (
              <Input
                value={criterionName}
                onChange={(e) => setCriterionName(e.target.value)}
                className="font-medium"
              />
            ) : (
              <CardTitle className="text-base font-medium leading-tight">
                {descriptor.criterionName}
              </CardTitle>
            )}

            <div className="flex items-center gap-2 mt-1 text-xs text-muted-foreground flex-wrap">
              <Badge variant="outline">{descriptor.code}</Badge>
              {descriptor.wsosSection && (
                <Badge>{descriptor.wsosSection.name}</Badge>
              )}
              {descriptor.createdBy && (
                <>
                  <span>from</span>
                  <span className="font-medium">
                    {descriptor.createdBy.name || descriptor.createdBy.email}
                  </span>
                </>
              )}
              {descriptor.submittedAt && (
                <>
                  <span>submitted</span>
                  <span>
                    {new Date(descriptor.submittedAt).toLocaleDateString()}
                  </span>
                </>
              )}
            </div>
          </div>

          <div className="flex items-center gap-2 shrink-0">
            {!editing && (
              <>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setExpanded(true);
                    setEditing(true);
                  }}
                >
                  <Pencil className="h-4 w-4 mr-1" />
                  Edit
                </Button>
                <Button size="sm" onClick={handleApprove} disabled={isPending}>
                  {isPending ? (
                    <Loader2 className="h-4 w-4 animate-spin" />
                  ) : (
                    <>
                      <Check className="h-4 w-4 mr-1" />
                      Approve
                    </>
                  )}
                </Button>
                <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
                  <DialogTrigger asChild>
                    <Button variant="destructive" size="sm">
                      <Undo2 className="h-4 w-4 mr-1" />
                      Return
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Return Descriptor</DialogTitle>
                      <DialogDescription>
                        Return this descriptor to the SCM with feedback on what
                        needs to be changed.
                      </DialogDescription>
                    </DialogHeader>
                    <div className="space-y-4">
                      <div>
                        <Label htmlFor="returnComment">Feedback for SCM</Label>
                        <Textarea
                          id="returnComment"
                          value={returnComment}
                          onChange={(e) => setReturnComment(e.target.value)}
                          placeholder="Please explain what needs to be revised..."
                          rows={4}
                        />
                      </div>
                    </div>
                    <DialogFooter>
                      <DialogClose asChild>
                        <Button variant="outline">Cancel</Button>
                      </DialogClose>
                      <Button
                        variant="destructive"
                        onClick={handleReturn}
                        disabled={isPending || returnComment.length < 5}
                      >
                        {isPending ? (
                          <Loader2 className="h-4 w-4 mr-1 animate-spin" />
                        ) : (
                          "Return to SCM"
                        )}
                      </Button>
                    </DialogFooter>
                  </DialogContent>
                </Dialog>
              </>
            )}
          </div>
        </div>
      </CardHeader>

      {expanded && (
        <CardContent className="pt-0">
          <div className="ml-7 pt-3 border-t space-y-4">
            {editing ? (
              <>
                {/* Score fields for editing */}
                <div className="grid gap-4 md:grid-cols-2">
                  <div className="space-y-2">
                    <Label className="text-green-700">Score 3 (Excellent)</Label>
                    <Textarea
                      value={score3}
                      onChange={(e) => setScore3(e.target.value)}
                      rows={6}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label className="text-blue-700">Score 2 (Good)</Label>
                    <Textarea
                      value={score2}
                      onChange={(e) => setScore2(e.target.value)}
                      rows={6}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label className="text-yellow-700">Score 1 (Acceptable)</Label>
                    <Textarea
                      value={score1}
                      onChange={(e) => setScore1(e.target.value)}
                      rows={6}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label className="text-red-700">Score 0 (Below Standard)</Label>
                    <Textarea
                      value={score0}
                      onChange={(e) => setScore0(e.target.value)}
                      rows={6}
                    />
                  </div>
                </div>

                <div className="flex gap-2 justify-end">
                  <Button variant="outline" size="sm" onClick={handleCancelEdit}>
                    <X className="h-4 w-4 mr-1" />
                    Cancel
                  </Button>
                  <Button size="sm" onClick={handleApprove} disabled={isPending}>
                    {isPending ? (
                      <Loader2 className="h-4 w-4 mr-1 animate-spin" />
                    ) : (
                      <Check className="h-4 w-4 mr-1" />
                    )}
                    Approve with Changes
                  </Button>
                </div>
              </>
            ) : (
              <div className="space-y-3 text-sm">
                {descriptor.score3 && (
                  <div>
                    <span className="font-medium text-green-700">Score 3:</span>{" "}
                    <span className="text-muted-foreground">
                      {descriptor.score3}
                    </span>
                  </div>
                )}
                {descriptor.score2 && (
                  <div>
                    <span className="font-medium text-blue-700">Score 2:</span>{" "}
                    <span className="text-muted-foreground">
                      {descriptor.score2}
                    </span>
                  </div>
                )}
                {descriptor.score1 && (
                  <div>
                    <span className="font-medium text-yellow-700">Score 1:</span>{" "}
                    <span className="text-muted-foreground">
                      {descriptor.score1}
                    </span>
                  </div>
                )}
                {descriptor.score0 && (
                  <div>
                    <span className="font-medium text-red-700">Score 0:</span>{" "}
                    <span className="text-muted-foreground">
                      {descriptor.score0}
                    </span>
                  </div>
                )}
              </div>
            )}
          </div>
        </CardContent>
      )}
    </Card>
  );
}
```
  </action>
  <verify>
1. Component file exists
2. TypeScript compiles: `npx tsc --noEmit`
3. Component uses Dialog for return comment
4. Component has expand/collapse, edit mode, approve, return buttons
  </verify>
  <done>PendingReviewCard component created with expandable view, inline editing, approve button, and return with comment dialog.</done>
</task>

<task type="auto">
  <name>Task 3: Update SCM page and edit page for RETURNED descriptors</name>
  <files>
    src/app/(dashboard)/hub/descriptors/my-descriptors/page.tsx
    src/app/(dashboard)/hub/descriptors/my-descriptors/[id]/edit/page.tsx
  </files>
  <action>
**Update my-descriptors/page.tsx:**

Find the RETURNED section (around line 213-248) and add edit button. Replace the comment `{/* Note: Edit functionality for returned items will be added in Phase 8 */}` with an actual edit button:

```tsx
{/* In the returnedDescriptors.map loop, add this after the reviewComment display */}
<div className="flex gap-2 mt-2">
  <Button asChild variant="outline" size="sm">
    <Link href={`/hub/descriptors/my-descriptors/${descriptor.id}/edit`}>
      <Pencil className="h-4 w-4 mr-1" />
      Edit & Resubmit
    </Link>
  </Button>
</div>
```

The full RETURNED section should look like:
```tsx
{/* Returned Section (needs attention) */}
{returnedDescriptors.length > 0 && (
  <Card className="border-red-200">
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <AlertCircle className="h-5 w-5 text-red-500" />
        Returned for Revision
      </CardTitle>
      <CardDescription>
        {returnedDescriptors.length} descriptor(s) returned by SA with comments
      </CardDescription>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        {returnedDescriptors.map((descriptor) => (
          <div
            key={descriptor.id}
            className="flex items-start justify-between gap-4 rounded-md border border-red-200 p-4"
          >
            <div className="min-w-0 flex-1">
              <div className="flex items-center gap-2 flex-wrap">
                <Badge variant="outline">{descriptor.code}</Badge>
                <Badge className="bg-red-100 text-red-800">Returned</Badge>
              </div>
              <h3 className="mt-2 font-medium">{descriptor.criterionName}</h3>
              {descriptor.reviewComment && (
                <p className="mt-2 text-sm text-red-700 bg-red-50 p-2 rounded">
                  SA Comment: {descriptor.reviewComment}
                </p>
              )}
            </div>
            <div className="flex gap-2">
              <Button asChild variant="outline" size="sm">
                <Link href={`/hub/descriptors/my-descriptors/${descriptor.id}/edit`}>
                  <Pencil className="h-4 w-4 mr-1" />
                  Edit
                </Link>
              </Button>
            </div>
          </div>
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

**Update [id]/edit/page.tsx:**

1. Change the status check (around line 41-43) to allow both DRAFT and RETURNED:

Replace:
```typescript
// Can only edit DRAFT descriptors
if (descriptor.batchStatus !== DescriptorBatchStatus.DRAFT) {
  redirect("/hub/descriptors/my-descriptors?error=Only%20draft%20descriptors%20can%20be%20edited");
}
```

With:
```typescript
// Can only edit DRAFT or RETURNED descriptors
const canEdit =
  descriptor.batchStatus === DescriptorBatchStatus.DRAFT ||
  descriptor.batchStatus === DescriptorBatchStatus.RETURNED;

if (!canEdit) {
  redirect("/hub/descriptors/my-descriptors?error=This%20descriptor%20cannot%20be%20edited");
}
```

2. Change the form action to use the appropriate action based on status. Around line 81, replace:
```tsx
<form action={updateSCMDescriptorAction} className="space-y-6">
```

With:
```tsx
<form
  action={descriptor.batchStatus === DescriptorBatchStatus.RETURNED
    ? updateReturnedDescriptorAction
    : updateSCMDescriptorAction
  }
  className="space-y-6"
>
```

3. Add import for updateReturnedDescriptorAction at the top:
```typescript
import { updateSCMDescriptorAction, updateReturnedDescriptorAction } from "../../actions";
```

4. Show SA comment if editing a RETURNED descriptor. Add after the error card (around line 71):
```tsx
{descriptor.batchStatus === DescriptorBatchStatus.RETURNED && descriptor.reviewComment && (
  <Card className="border-red-200 bg-red-50">
    <CardContent className="py-4">
      <p className="text-sm font-medium text-red-700">SA Feedback:</p>
      <p className="text-sm text-red-600 mt-1">{descriptor.reviewComment}</p>
    </CardContent>
  </Card>
)}
```

5. Update the description text for RETURNED:
```tsx
<p className="mt-2 text-muted-foreground">
  {descriptor.batchStatus === DescriptorBatchStatus.RETURNED
    ? "Address the SA feedback and save to move back to draft, then resubmit."
    : "Update your draft descriptor before submitting for review."}
</p>
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. RETURNED descriptors show edit button
3. Edit page accepts both DRAFT and RETURNED status
4. Edit page uses correct action based on status
  </verify>
  <done>SCM page shows edit button for RETURNED descriptors; edit page allows editing both DRAFT and RETURNED status descriptors with appropriate action.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. SA can access /hub/descriptors/pending-review
3. SA sees only their SCM's pending descriptors
4. SA can approve (with or without edits)
5. SA can return with comment via dialog
6. SCM sees edit button on RETURNED descriptors
7. SCM edit page works for both DRAFT and RETURNED
</verification>

<success_criteria>
- [ ] SA pending review page renders at /hub/descriptors/pending-review
- [ ] Page only accessible to SA role (redirects others)
- [ ] PendingReviewCard has expand/collapse functionality
- [ ] PendingReviewCard has inline editing for descriptor fields
- [ ] Approve button calls approveDescriptorAction
- [ ] Return button opens dialog for comment entry
- [ ] SCM page shows edit button for RETURNED descriptors
- [ ] Edit page allows both DRAFT and RETURNED status
- [ ] Edit page shows SA feedback for RETURNED descriptors
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sa-approval-workflow/08-04-SUMMARY.md`
</output>
